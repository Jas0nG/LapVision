<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèéÔ∏è LapVision </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f0f0f;
            color: #e5e5e5;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #0f0f0f;
        }

        /* ‰∏ì‰∏öÂâ™ËæëËΩØ‰ª∂È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */
        .top-toolbar {
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border-bottom: 1px solid #333;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .app-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .toolbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* È¢ÑËßàÂå∫Âüü */
        .preview-section {
            flex: 1;
            display: flex;
            background: #272727;
            border-bottom: 1px solid #333;
            min-height: 400px;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            height: 100%; /* Á°Æ‰øùÂ°´Êª°Áà∂ÂÖÉÁ¥†È´òÂ∫¶ */
        }

        /* Êó∂Èó¥ËΩ¥Âå∫Âüü */
        .timeline-section {
            background: #202020;
            border-top: 1px solid #333;
            padding: 20px;
            min-height: 200px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
        }

        /* ÊéßÂà∂Èù¢Êùø */
        .control-panel {
            width: 500px;
            background: #202020;
            border-left: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1em;
            color: #9ca3af;
        }

        /* ‰∏ì‰∏öÊó∂Èó¥ËΩ¥Ê†∑Âºè */
        .timeline-container {
            background: #222222;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            border: 1px solid #333;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1px;
        }

        .timeline-title {
            font-size: 0.9em;
            font-weight: 500;
            color: #ccc;
        }

        .timeline-right-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .timeline-info {
            font-size: 0.8em;
            color: #888;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .timeline-shortcuts {
            display: flex;
            gap: 12px;
            opacity: 0.6;
        }

        .timeline-shortcuts .shortcut {
            font-size: 0.7em;
            color: #666;
            font-family: 'Monaco', 'Menlo', monospace;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-track {
            position: relative;
            height: 60px;
            background: #0a0a0a;
            border-radius: 4px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .timeline-ruler {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .timeline-ruler-marks {
            position: relative;
            height: 100%;
            background-image: repeating-linear-gradient(
                90deg,
                #444 0px,
                #444 1px,
                transparent 1px,
                transparent 50px
            );
        }

        .timeline-playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff4444;
            box-shadow: 0 0 6px rgba(255, 68, 68, 0.6);
            z-index: 10;
            transition: left 0.1s ease;
        }

        .timeline-playhead::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -6px;
            width: 14px;
            height: 14px;
            background: #ff4444;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 68, 68, 0.8);
        }

        .timeline-waveform {
            position: absolute;
            top: 21px;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(59, 130, 246, 0.1) 0%,
                rgba(59, 130, 246, 0.3) 50%,
                rgba(59, 130, 246, 0.1) 100%
            );
            background-size: 4px 100%;
        }

        /* Èù¢ÊùøÊ†∑Âºè */
        .panel {
            background: linear-gradient(180deg, #1f1f1f 0%, #1a1a1a 100%);
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #333;
            background: #222;
            border-radius: 7px 7px 0 0;
        }

        .panel-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .panel-content {
            padding: 16px;
        }

        /* ÁΩëÊ†ºÂ∏ÉÂ±Ä */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        /* ‰∏ì‰∏öË°®ÂçïÊéß‰ª∂ */
        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85em;
            font-weight: 500;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #e5e5e5;
            font-size: 0.9em;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
            background: #111;
        }

        /* ‰∏ì‰∏öÊåâÈíÆ */
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white;
            font-size: 1.2em;
            padding: 12px 24px;
            display: block;
            text-align: center;
            margin: 0 auto;
            border-color: #1e3a8a;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: #222;
            color: #ccc;
            border-color: #444;
        }

        .btn-secondary:hover {
            background: #333;
            border-color: #555;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .btn-icon {
            padding: 8px;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* Êñá‰ª∂‰∏ä‰º†Âå∫Âüü */
        .file-upload-area {
            border: 2px dashed #444;
            border-radius: 8px;
            padding: 18px;
            text-align: center;
            background: #1a1a1a;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .file-upload-area:hover {
            border-color: #666;
            background: #1f1f1f;
        }

        .file-upload-area.drag-over {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .upload-icon {
            font-size: 2.5em;
            opacity: 0.6;
        }

        .upload-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .upload-main {
            font-size: 1.1em;
            font-weight: 500;
            color: #e5e5e5;
        }

        .upload-sub {
            font-size: 0.9em;
            color: #999;
        }

        .upload-link {
            color: #ff6b35;
            text-decoration: underline;
            cursor: pointer;
        }

        .upload-link:hover {
            color: #ff8c5a;
        }

        .upload-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 8px;
        }

        .upload-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 26, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
            border-radius: 8px;
        }

        .progress-bar {
            width: 80%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #ff8c5a);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9em;
            color: #ccc;
        }

        /* ‰∏ì‰∏öËßÜÈ¢ëÈ¢ÑËßà */
        .video-preview {
            position: relative;
            max-width: 800px;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .video-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .video-preview:hover .video-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        .playback-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .playback-controls button {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .playback-controls button:hover {
            background: rgba(255, 107, 53, 0.9);
            border-color: #ff6b35;
            transform: scale(1.1);
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 16px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .video-timestamp {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .keyboard-hints {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .keyboard-hints .hint {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(0, 0, 0, 0.6);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            text-shadow: none;
        }

        .preview-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            background: #272727;
            border: 5px dashed #333;
            border-radius: 8px;
            color: #666;
            font-size: 1.1em;
            aspect-ratio: 16 / 9;
        }

        /* ÊªëÂùó */
        .slider-container {
            margin: 20px 0;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #3f4857;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* ÁîªÂªä */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .gallery-item {
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .gallery-item:hover {
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .gallery-item.selected {
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .gallery-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
        }

        .gallery-item .label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: #e0e0e0;
            padding: 4px 8px;
            font-size: 0.75em;
            text-align: center;
        }

        /* ÁªüËÆ°‰ø°ÊÅØ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .stat-box {
            background: #1e1e2e;
            border: 1px solid #3f4857;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #3b82f6;
        }

        /* ÊµÆÂä®ÈÄöÁü•ÊèêÁ§∫ */
        .toast-container {
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 1000;
            pointer-events: none;
        }

        .toast {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transform: translateX(-100%) scale(0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }

        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0) scale(1);
        }

        .toast.success {
            background: rgba(16, 185, 129, 0.15);
            color: #a7f3d0;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .toast.success::before {
            background: #10b981;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .toast.error::before {
            background: #ef4444;
        }

        .toast.info {
            background: rgba(6, 182, 212, 0.15);
            color: #a5f3fc;
            border-color: rgba(6, 182, 212, 0.3);
        }

        .toast.info::before {
            background: #06b6d4;
        }

        .toast-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.1em;
        }

        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: currentColor;
            opacity: 0.6;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: opacity 0.2s ease;
        }

        .toast-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes slideInToast {
            from {
                opacity: 0;
                transform: translateX(100%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes slideOutToast {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateX(100%) scale(0.9);
            }
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Èò∂ÊÆµÊåáÁ§∫ */
        .phase-indicator {
            display: flex;
            gap: 8px;
        }

        .phase {
            padding: 4px 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #999;
            font-size: 0.75em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .phase.active {
            background: #ff6b35;
            border-color: #ff6b35;
            color: white;
        }

        .phase.completed {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Â∑•ÂÖ∑ÊèêÁ§∫ */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #3b82f6;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1e1e2e;
            color: #e0e0e0;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #3b82f6;
            font-size: 0.9em;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Á¨¨‰∫åÊ≠•Áé∞‰ª£ÂåñËÆæËÆ° */
        #phase2-card {
            text-align: center;
        }

        #phase2-card .control-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        #phase2-card .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 140px;
        }

        #phase2-card .control-item label {
            font-size: 0.85em;
            margin-bottom: 8px;
            color: #d0d0d0;
            font-weight: 500;
        }

        #phase2-card .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1e1e2e;
            border: 1px solid #3f4857;
            border-radius: 8px;
            padding: 4px;
            width: 140px;
        }

        #phase2-card .compact-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 12px;
            color: #e0e0e0;
            font-size: 0.9em;
            min-width: 0;
        }

        #phase2-card .compact-input:focus {
            outline: none;
            box-shadow: none;
        }

        #phase2-card .input-group:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        #phase2-card .compact-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        #phase2-card .compact-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        /* Áé∞‰ª£ÂåñÊªëÂùóËÆæËÆ° */
        #phase2-card .modern-slider-container {
            margin: 32px 0;
            padding: 0 8px;
        }

        #phase2-card .slider-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            font-weight: 500;
            color: #3b82f6;
        }

        #phase2-card .slider-wrapper {
            position: relative;
            background: #2d3748;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #3f4857;
        }

        #phase2-card .modern-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #3f4857 0%, #3f4857 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin: 12px 0;
        }

        #phase2-card .modern-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            cursor: pointer;
            border: 3px solid #1e1e2e;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
        }

        #phase2-card .modern-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        #phase2-card .modern-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            cursor: pointer;
            border: 3px solid #1e1e2e;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        #phase2-card .slider-track {
            position: absolute;
            top: 50%;
            left: 20px;
            right: 20px;
            height: 8px;
            background: #3f4857;
            border-radius: 4px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        #phase2-card .slider-progress {
            position: absolute;
            top: 50%;
            left: 20px;
            height: 8px;
            background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
            border-radius: 4px;
            transform: translateY(-50%);
            width: 0%;
            transition: width 0.1s ease;
            pointer-events: none;
        }

        #phase2-card .frame-info {
            margin-top: 16px;
            padding: 12px 16px;
            background: #1e1e2e;
            border: 1px solid #3f4857;
            border-radius: 8px;
            color: #9ca3af;
            font-size: 0.9em;
            font-family: 'Monaco', 'Menlo', monospace;
            text-align: center;
        }

        #phase2-card .button-group {
            justify-content: center;
            margin-top: 32px;
        }

        /* ÈöêËóèÂÖÉÁ¥† */
        .hidden {
            display: none !important;
        }

        /* ËøõÂ∫¶ÊåáÁ§∫ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #3f4857;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Êìç‰ΩúÊåáÂçóÊ†∑Âºè */
        .guide-box {
            background: linear-gradient(135deg, #ffffff 0%, #101f4e 100%);
            border: 1px solid #ececec;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .guide-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffffff, #06b6d4, #3b82f6);
            border-radius: 8px;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite;
        }

        @keyframes borderGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .guide-box .guide-icon {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 6px;
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
        }

        .guide-content h5 {
            color: #fff;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .guide-content p {
            color: #e2e8f0;
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 12px;
            text-align: center;
        }

        .guide-steps {
            margin-top: 12px;
        }

        .guide-steps .step {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            padding: 4px 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .guide-steps .step:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(4px);
        }

        .guide-steps .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #ff6b35;
            color: white;
            border-radius: 50%;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .guide-steps .step span:not(.step-number) {
            color: #f1f5f9;
            font-size: 0.85em;
        }

        .guide-tips {
            margin-top: 12px;
        }

        .guide-tips .tip {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 4px;
            color: #cbd5e1;
            font-size: 0.8em;
            line-height: 1.4;
        }

        .guide-tips .tip::before {
            content: attr(data-emoji);
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* ‰∏∫‰∏çÂêåÈò∂ÊÆµ‰ΩøÁî®‰∏çÂêåÁöÑ‰∏ªËâ≤Ë∞É */
        .phase-1-guide .guide-box {
            background: linear-gradient(135deg, #024731 0%, #084f37 100%);
            border-color: #024731;
        }

        .phase-1-guide .guide-box::before {
            background: linear-gradient(45deg, #064e3b, #065f46, #064e3b);
        }

        .phase-2-guide .guide-box {
            background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
            border-color: #2563eb;
        }

        .phase-2-guide .guide-box::before {
            background: linear-gradient(45deg, #2563eb, #3b82f6, #2563eb);
        }

        .phase-3-guide .guide-box {
            background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%);
            border-color: #6d28d9;
        }

        .phase-3-guide .guide-box::before {
            background: linear-gradient(45deg, #6d28d9, #8b5cf6, #6d28d9);
        }

        /* Èò∂ÊÆµ3Á¥ßÂáëÂ∏ÉÂ±ÄÊ†∑Âºè */
        .phase3-main-layout {
            display: flex;
            gap: 16px;
            height: 100%;
            width: 100%;
            align-items: flex-start; /* Êîπ‰∏∫È°∂ÈÉ®ÂØπÈΩêÔºåÈÅøÂÖçÊãâ‰º∏ */
            position: absolute; /* ‰ΩøÁî®ÁªùÂØπÂÆö‰ΩçÁ°Æ‰øùÂõ∫ÂÆöÈ´òÂ∫¶ */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .phase3-preview-area {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
            overflow-y: auto; /* ÂÖÅËÆ∏ÂÜÖÂÆπÊªöÂä® */
        }

        .phase3-stats-area {
            flex: 0 0 280px; /* Âõ∫ÂÆöÂÆΩÂ∫¶Ôºå‰∏ç‰º∏Áº© */
            min-width: 240px;
            max-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%; /* Âõ∫ÂÆöÂ°´Êª°ÂÆπÂô®È´òÂ∫¶ */
            position: relative; /* Á°Æ‰øùÂ≠êÂÖÉÁ¥†Ê≠£Á°ÆÂÆö‰Ωç */
        }

        /* Á¥ßÂáëÂèåÁîªÈù¢È¢ÑËßà */
        .compact-dual-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
            height: 350px; /* Ëøõ‰∏ÄÊ≠•Â¢ûÂ§ßÈ´òÂ∫¶ */
        }

        .compact-preview-half {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .compact-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #222;
            border-bottom: 1px solid #333;
        }

        .preview-label {
            font-size: 0.75em;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-time {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.7em;
            color: #ff6b35;
            font-weight: 500;
        }

        .compact-video-preview {
            position: relative;
            background: #000;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compact-video-preview img {
            width: 100%;
            height: 100%;
            max-height: none;
            object-fit: contain;
            display: block;
        }

        .compact-video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .compact-video-preview:hover .compact-video-overlay {
            opacity: 1;
        }

        .compact-playback-controls {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compact-play-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .compact-play-btn:hover {
            background: rgba(255, 107, 53, 0.9);
            border-color: #ff6b35;
            transform: scale(1.1);
        }

        /* ÂÄôÈÄâÂ∏ßÊòæÁ§∫ */
        .candidates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px 6px 0 0;
            margin-bottom: 0;
        }

        .candidates-header h4 {
            margin: 0;
            font-size: 0.8em;
            color: #fff;
            font-weight: 600;
        }

        .candidates-hint {
            font-size: 0.7em;
            color: #999;
        }

        .compact-candidates-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 8px;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 500px;
            overflow-y: auto;
        }

        .compact-candidates-gallery .gallery-item {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .compact-candidates-gallery .gallery-item:hover {
            border-color: #3b82f6;
            transform: scale(1.02);
        }

        .compact-candidates-gallery .gallery-item.selected {
            border-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }

        .compact-candidates-gallery .gallery-item img {
            width: 100%;
            height: 160px; /* ÂáèÂ∞èÂõæÁâáÈ´òÂ∫¶ */
            object-fit: cover;
        }

        .compact-candidates-gallery .gallery-item .label {
            padding: 4px 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #e0e0e0;
            font-size: 0.7em;
            text-align: center;
            line-height: 1.2;
        }

        /* Á¥ßÂáëÁªüËÆ°Èù¢Êùø */
        .compact-stats-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%; /* Á°Æ‰øùÂ°´Êª°ÂÆπÂô®È´òÂ∫¶ */
            min-height: 0; /* ÂÖÅËÆ∏ÂÜÖÂÆπÊî∂Áº© */
        }

        .compact-stats-header {
            padding: 10px 12px;
            background: #222;
            border-bottom: 1px solid #333;
        }

        .compact-stats-header h4 {
            margin: 0;
            font-size: 0.8em;
            color: #fff;
            font-weight: 600;
        }

        .compact-stats-content {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
        }

        .stats-placeholder {
            color: #666;
            text-align: center;
            font-size: 0.8em;
            padding: 20px 0;
        }

        /* ÁÆÄÂåñÁöÑÁªüËÆ°ÊòæÁ§∫ */
        .compact-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .compact-stat-box {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
        }

        .compact-stat-label {
            font-size: 0.65em;
            color: #999;
            margin-bottom: 4px;
        }

        .compact-stat-value {
            font-size: 0.8em;
            font-weight: 600;
            color: #3b82f6;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .compact-laps-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .compact-lap-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-bottom: 1px solid #333;
            font-size: 0.75em;
        }

        .compact-lap-item:last-child {
            border-bottom: none;
        }

        .compact-lap-item.latest-lap {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1200px) {
            .phase3-main-layout {
                flex-direction: column;
                position: relative; /* Âú®Â∞èÂ±èÂπï‰∏ä‰ΩøÁî®Áõ∏ÂØπÂÆö‰Ωç */
                height: auto;
            }
            
            .phase3-stats-area {
                flex: 0 0 auto; /* Âú®ÂûÇÁõ¥Â∏ÉÂ±ÄÊó∂‰ΩøÁî®Ëá™Âä®È´òÂ∫¶ */
                max-width: none;
                min-width: 0;
                height: auto;
                min-height: 300px; /* ËÆæÁΩÆÊúÄÂ∞èÈ´òÂ∫¶Á°Æ‰øùÂèØÁî®ÊÄß */
            }
            
            .phase3-preview-area {
                height: auto; /* Âú®ÂûÇÁõ¥Â∏ÉÂ±ÄÊó∂‰ΩøÁî®Ëá™Âä®È´òÂ∫¶ */
                overflow-y: visible;
            }
            
            .compact-dual-preview {
                height: 250px;
            }
            
            .timeline-shortcuts {
                gap: 8px;
            }
            
            .timeline-shortcuts .shortcut {
                font-size: 0.65em;
                padding: 1px 4px;
            }
        }

        @media (max-width: 768px) {
            .compact-dual-preview {
                grid-template-columns: 1fr;
                height: 400px;
            }
            
            .compact-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .timeline-shortcuts {
                display: none; /* Âú®Â∞èÂ±èÂπï‰∏äÈöêËóèÂø´Êç∑ÈîÆÊèêÁ§∫ */
            }
            
            .timeline-right-info {
                align-items: center;
            }
            
            .phase3-stats-area {
                min-width: unset;
                max-width: unset;
            }

            /* ÁßªÂä®ËÆæÂ§á‰∏äÁöÑtoastÊ†∑Âºè */
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .toast {
                min-width: auto;
                width: 100%;
                margin-bottom: 8px;
                font-size: 0.9em;
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
        <div class="top-toolbar">
            <div class="app-title" style="margin-right: 40px;">
                üèéÔ∏è LapVision
                <span style="font-size: 0.8em; color: #9ca3af; margin-left: 20px;">Analysis race chrono from onboard video</span>
            </div>
            <div class="toolbar-actions">
                <div class="phase-indicator">
                    <div class="phase active" id="phase-1">ÂàùÂßãÂåñ</div>
                    <div class="phase" id="phase-2">ËÆæÁΩÆÂèÇËÄÉÂ∏ß</div>
                    <div class="phase" id="phase-3">ÊêúÁ¥¢ÂúàÈÄü</div>
                </div>
            </div>
        </div>

        <!-- ÊµÆÂä®ÈÄöÁü•ÂÆπÂô® -->
        <div id="toast-container" class="toast-container"></div>

        <!-- ‰∏ªÂÜÖÂÆπ -->
        <div class="main-content">

            <!-- È¢ÑËßàÂå∫Âüü -->
            <div class="preview-section">
                <div class="preview-panel">
                    <div id="phase1-content">
                        <div class="preview-placeholder">
                            <div style="text-align: center;">
                                <h3>ÈÄâÊã©ËßÜÈ¢ëÊñá‰ª∂ÂºÄÂßã</h3>
                                <p>Âä†ËΩΩËßÜÈ¢ëÂêéÂ∞ÜÂú®Ê≠§Â§ÑÊòæÁ§∫È¢ÑËßà</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="phase2-content" class="hidden">
                        <div class="video-preview">
                            <img id="frame-preview" src="" alt="ËßÜÈ¢ëÈ¢ÑËßà" style="display: none;">
                            <div class="video-overlay" id="video-overlay">
                                <div class="playback-controls">
                                    <button class="btn-icon" id="play-pause-btn" onclick="togglePlayback()" title="Êí≠Êîæ/ÊöÇÂÅú (Á©∫Ê†º)">
                                        <span id="play-icon">‚ñ∂Ô∏è</span>
                                    </button>
                                </div>
                            </div>
                            <div class="video-controls">
                                <div class="video-timestamp" id="video-timestamp">00:00:00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="phase3-content" class="hidden" style="position: relative; height: 100%; width: 100%;">
                        <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü - Ê∞¥Âπ≥ÂàÜÂ∏É -->
                        <div class="phase3-main-layout" style="padding: 20px;">
                            <!-- Â∑¶‰æßÔºöÂèåÁîªÈù¢È¢ÑËßà -->
                            <div class="phase3-preview-area">
                                <div class="compact-dual-preview">
                                    <!-- ÂèÇËÄÉÂ∏ß -->
                                    <div class="compact-preview-half">
                                        <div class="compact-preview-header">
                                            <span class="preview-label">üèÅ ÂèÇËÄÉÂ∏ß</span>
                                            <span class="preview-time" id="ref-frame-timestamp">--:--:--</span>
                                        </div>
                                        <div class="compact-video-preview">
                                            <img id="ref-frame-display" src="" alt="ÂèÇËÄÉÂ∏ß">
                                        </div>
                                    </div>
                                    
                                    <!-- ÂΩìÂâçÂ∏ß -->
                                    <div class="compact-preview-half">
                                        <div class="compact-preview-header">
                                            <span class="preview-label">üéØ ÂÜ≤Á∫øÊó∂Âàª</span>
                                            <span class="preview-time" id="current-video-timestamp">00:00:00</span>
                                        </div>
                                        <div class="compact-video-preview">
                                            <img id="current-frame-display" src="" alt="ÂÜ≤Á∫øÊó∂Âàª" style="display: none;">
                                            <div class="compact-video-overlay" id="current-video-overlay">
                                                <div class="compact-playback-controls">
                                                    <button class="compact-play-btn" id="current-play-pause-btn" onclick="togglePlayback()" title="Êí≠Êîæ/ÊöÇÂÅú (Á©∫Ê†º)">
                                                        <span id="current-play-icon">‚ñ∂Ô∏è</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ÂÄôÈÄâÂ∏ßÂå∫Âüü - ÁßªÂà∞È¢ÑËßà‰∏ãÊñπ -->
                                <div id="candidates-display" class="hidden">
                                    <div class="candidates-header">
                                        <h4>ËØ∑ÈÄâÊã©ÂÜ≤Á∫øÊó∂Âàª</h4>
                                        <span class="candidates-hint">Áî±Á≥ªÁªüËá™Âä®ËØÜÂà´</span>
                                    </div>
                                    <div class="compact-candidates-gallery" id="candidates-gallery"></div>
                                </div>
                            </div>
                            
                            <!-- Âè≥‰æßÔºöÁ¥ßÂáëÁªüËÆ°Èù¢Êùø -->
                            <div class="phase3-stats-area">
                                <div class="compact-stats-panel" id="stats-display">
                                    <div class="compact-stats-header">
                                        <h4>üìä ÂúàÈÄüËÆ∞ÂΩï</h4>
                                    </div>
                                    <div class="compact-stats-content" id="stats-container">
                                        <div class="stats-placeholder">Á≠âÂæÖÊêúÁ¥¢...</div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÊéßÂà∂Èù¢Êùø -->
                <div class="control-panel" id="control-panel"></div>
            </div>

            <!-- Êó∂Èó¥ËΩ¥Âå∫Âüü -->
            <div class="timeline-section">
                <div class="timeline-container">
                    <div class="timeline-header">
                        <div class="timeline-title">Êó∂Èó¥ËΩ¥</div>
                        <div class="timeline-right-info">
                            <div class="timeline-shortcuts" id="timeline-shortcuts">
                                <span class="shortcut">Á©∫Ê†º: Êí≠Êîæ/ÊöÇÂÅú</span>
                                <span class="shortcut">‚Üê ‚Üí: ÈÄêÂ∏ß</span>
                                <span class="shortcut">Shift+‚Üê ‚Üí: ¬±5Â∏ß</span>
                            </div>
                            <div class="timeline-info" id="timeline-info">00:00:00 / 00:00:00</div>
                        </div>
                    </div>
                    <div class="timeline-track" onclick="seekToPosition(event)">
                        <div class="timeline-ruler">
                            <div class="timeline-ruler-marks"></div>
                        </div>
                        <div class="timeline-waveform"></div>
                        <div class="timeline-playhead" id="playhead" style="left: 0%;"></div>
                    </div>
                </div>




            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let appState = {
            counterId: null,
            selectedCandidate: null,
            videoInfo: null,
            sliderDebounceTimer: null,
            currentFrame: 0,
            isPlaying: false,
            playbackTimer: null,
            confirmedLaps: 0
        };

        // Êõ¥Êñ∞ÊéßÂà∂Èù¢ÊùøÂÜÖÂÆπ
        function updateControlPanel(phase) {
            const panel = document.getElementById('control-panel');
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈò∂ÊÆµÊ†∑ÂºèÁ±ª
            panel.classList.remove('phase-1-guide', 'phase-2-guide', 'phase-3-guide');
            // Ê∑ªÂä†ÂΩìÂâçÈò∂ÊÆµÁöÑÊ†∑ÂºèÁ±ª
            panel.classList.add(`phase-${phase}-guide`);
            
            switch(phase) {
                case 1:
                    panel.innerHTML = `
                                <div class="guide-box">
                                    <div class="guide-icon">üèÅ</div>
                                    <div class="guide-content">
                                        <h5>Welcome to <strong>LapVision</strong> (Karting Version) </h5>
                                        <p><strong>LapVision</strong> ÊòØ‰∏Ä‰∏™Âü∫‰∫éËßÜËßâÁöÑËµõËΩ¶ËÆ°Êó∂Â∑•ÂÖ∑ÔºåËÉΩÂ§üËá™Âä®ÂàÜÊûêÊÇ®ÁöÑËµõÈÅìËΩ¶ËΩΩËßÜÈ¢ëÂπ∂ËæÖÂä©ÂàÜÊûêÊÇ®ÁöÑÂúàÈÄü‰ø°ÊÅØ„ÄÇ</p>
                                        <div class="guide-steps">
                                            <div class="step">
                                                <span class="step-number">1</span>
                                                <span>Âä†ËΩΩÊú™ÁªèÂâ™ËæëÁöÑËΩ¶ËΩΩËßÜÈ¢ë</span>
                                            </div>
                                            <div class="step">
                                                <span class="step-number">2</span>
                                                <span>ÈÄâÊã©Á¨¨‰∏ÄÊ¨°ÁªèËøáËµ∑ÁÇπ/ÁªàÁÇπÁ∫øÁöÑÂèÇËÄÉÂ∏ß</span>
                                            </div>
                                            <div class="step">
                                                <span class="step-number">3</span>
                                                <span>Ëá™Âä®ÂàÜÊûêÂπ∂ÁîüÊàêÂúàÈÄüÁªüËÆ°‰ø°ÊÅØ</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        
                        <div class="panel">
                            <div class="panel-header">
                                <h4 class="panel-title">È°πÁõÆËÆæÁΩÆ</h4>
                            </div>
                            <div class="panel-content">
                                <div class="form-group">
                                    
                                    <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
                                    <div class="file-upload-area" id="file-upload-area">
                                        <div class="upload-content">
                                            <div class="upload-icon">üìÅ</div>
                                            <div class="upload-text">
                                                <div class="upload-main">ÊãñÊãΩËßÜÈ¢ëÊñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
                                                <div class="upload-sub">ÊàñËÄÖ <span class="upload-link" id="browse-files">ÊµèËßàÊñá‰ª∂</span></div>
                                            </div>
                                            <div class="upload-info">ÊîØÊåÅ MP4, AVI, MOV Ê†ºÂºèÔºåÊúÄÂ§ß 500MB</div>
                                        </div>
                                        <div class="upload-progress" id="upload-progress" style="display: none;">
                                            <div class="progress-bar">
                                                <div class="progress-fill" id="progress-fill"></div>
                                            </div>
                                            <div class="progress-text" id="progress-text">‰∏ä‰º†‰∏≠...</div>
                                        </div>
                                    </div>
                                    
                                    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
                                    <input type="file" id="file-input" accept=".mp4,.avi,.mov" style="display: none;">
                                    
                                    <!-- ËßÜÈ¢ëÈÄâÊã©‰∏ãÊãâÊ°Ü -->
                                    <div class="form-group" style="margin-top: 16px;">
                                        <label>ÊàñÈÄâÊã©Â∑≤ÊúâËßÜÈ¢ë</label>
                                        <select id="video-select">
                                            <option value="">ÈÄâÊã©ËßÜÈ¢ë...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>È¢Ñ‰º∞ÊúÄÂ∞èÂúàÈÄü(Áßí)   (Áî®‰∫éÂä†ÈÄüÊêúÁ¥¢)</label>
                                    <input type="number" id="min-lap-time" value="18" min="1" step="0.1">
                                </div>
                                <div class="button-group">
                                    <button class="btn-primary" id="btn-init" onclick="initCounter()">
                                        Âä†ËΩΩËßÜÈ¢ë
                                    </button>
                                </div>
                                <div id="video-info" class="hidden" style="margin-top: 16px; padding: 12px; background: #0a0a0a; border-radius: 4px; font-size: 0.8em;">
                                    <div><strong>FPS:</strong> <span id="info-fps"></span></div>
                                    <div><strong>ÊÄªÂ∏ßÊï∞:</strong> <span id="info-frames"></span></div>
                                    <div><strong>Êó∂Èïø:</strong> <span id="info-duration"></span></div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 2:
                    panel.innerHTML = `
                        <div class="guide-box">
                            <div class="guide-content">
                                <h5>ËÆæÁΩÆËÆ°Êó∂Ëµ∑ÁÇπ</h5>
                                <p>ËØ∑Â∞ÜÁîªÈù¢ÂÆö‰ΩçÂà∞ÊÇ®<strong>Á¨¨‰∏ÄÊ¨°ÁªèËøáËµ∑ÁÇπ/ÁªàÁÇπÁ∫ø</strong>ÁöÑÁîªÈù¢‰Ωú‰∏∫ÂèÇËÄÉ„ÄÇËØ•‰ΩçÁΩÆÂ∞Ü‰Ωú‰∏∫ÂêéÁª≠ÂúàÈÄüËÆ°ÁÆóÁöÑÂü∫ÂáÜÁÇπ„ÄÇ</p>
                                <div class="guide-tips">
                                    <div class="tip">üí° ‰ΩøÁî®Êí≠ÊîæÊéßÂà∂ÊàñÊãñÂä®Êó∂Èó¥ËΩ¥ÂÆö‰ΩçÂà∞ÂêàÈÄÇ‰ΩçÁΩÆ</div>
                                    <div class="tip">üéÆ ÊîØÊåÅÈîÆÁõòÂø´Êç∑ÈîÆÔºöÁ©∫Ê†ºÊí≠Êîæ/ÊöÇÂÅúÔºå‚Üê‚ÜíÈÄêÂ∏ßÊµèËßà, Shift+‚Üê/‚ÜíÂèØË∑≥ËΩ¨5Â∏ß</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel-header">
                                <h4 class="panel-title">Â∏ßÊéßÂà∂</h4>
                            </div>
                            <div class="panel-content">
                                <div class="form-group">
                                    <label>Â∏ßÂè∑</label>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="number" id="frame-number" value="0" min="0" style="flex: 1;">
                                        <button class="btn-secondary btn-small" onclick="jumpToFrame()">Ë∑≥ËΩ¨</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Êó∂Èó¥(Áßí)</label>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="number" id="frame-time" value="0" step="0.1" min="0" style="flex: 1;">
                                        <button class="btn-secondary btn-small" onclick="jumpToTime()">Ë∑≥ËΩ¨</button>
                                    </div>
                                </div>
                                <div class="button-group" style="margin-top: 16px;">
                                    <button class="btn-primary" id="btn-set-ref" onclick="setReferenceFrame()">
                                        ËÆæ‰∏∫Ëµ∑ÁÇπ/ÁªàÁÇπ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 3:
                    panel.innerHTML = `
                        <div class="guide-box">
                            <div class="guide-content">
                                <h5>ÂºÄÂßãÂúàÈÄüËÆ°ÁÆó</h5>
                                <p>Á≥ªÁªüÂ∞Ü‰ΩøÁî®AIËßÜËßâËØÜÂà´ÊäÄÊúØÔºåËá™Âä®Êü•ÊâæÂÜ≤Á∫øÊó∂ÂàªÔºåÁî®‰∫éËÆ°ÁÆóÊØè‰∏ÄÂúàÁöÑÁî®Êó∂„ÄÇ</p>
                                <div class="guide-tips">
                                    <div class="tip">üéØ ÁÇπÂáª"ÊêúÁ¥¢‰∏ã‰∏ÄÂúà"ÂºÄÂßãËá™Âä®ÂàÜÊûê</div>
                                    <div class="tip">üñ±Ô∏è ‰ªéÂÄôÈÄâÁªìÊûú‰∏≠ÈÄâÊã©ÊúÄÊé•ËøëÁöÑÁªàÁÇπÂ∏ß</div>
                                    <div class="tip">üéÆ ‰ΩøÁî®Êó∂Èó¥ËΩ¥ÂíåÈîÆÁõòÂø´Êç∑ÈîÆËøõË°åÁ≤æÁ°ÆË∞ÉÊï¥</div>
                                    <div class="tip">‚úÖ Á°ÆËÆ§ÂêéÂ∞Ü‰ºöËá™Âä®ÂºÄÂßã‰∏ã‰∏ÄÂúàÁöÑÂàÜÊûê</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel-header">
                                <h4 class="panel-title">ÂúàÈÄüÊêúÁ¥¢</h4>
                            </div>
                            <div class="panel-content">
                                <div class="button-group">
                                    <button class="btn-primary" id="btn-search" onclick="searchLap()">
                                        üîç ÂºÄÂßãÂàÜÊûê
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            // ÈáçÊñ∞Âä†ËΩΩËßÜÈ¢ëÂàóË°®ÔºàÂ¶ÇÊûúÂú®Èò∂ÊÆµ1Ôºâ
            if (phase === 1) {
                // Âª∂Ëøü‰∏ÄÂ∞èÊÆµÊó∂Èó¥Á°Æ‰øùDOMÂÖÉÁ¥†Â∑≤ÂàõÂª∫
                setTimeout(() => {
                    loadVideos();
                }, 50);
            }
        }

        // Êõ¥Êñ∞Êó∂Èó¥ËΩ¥‰ΩçÁΩÆ
        function updateTimelinePosition() {
            if (!appState.videoInfo) return;
            
            const percentage = (appState.currentFrame / appState.videoInfo.total_frames) * 100;
            const playhead = document.getElementById('playhead');
            if (playhead) {
                playhead.style.left = percentage + '%';
            }
            
            const currentTime = appState.currentFrame / appState.videoInfo.fps;
            const totalTime = appState.videoInfo.duration;
            const timeInfo = document.getElementById('timeline-info');
            if (timeInfo) {
                timeInfo.textContent = formatTime(currentTime) + ' / ' + formatTime(totalTime);
            }
        }

        // ÁÇπÂáªÊó∂Èó¥ËΩ¥Ë∑≥ËΩ¨
        function seekToPosition(event) {
            if (!appState.videoInfo) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = x / rect.width;
            const targetFrame = Math.floor(percentage * appState.videoInfo.total_frames);
            
            getFrame(targetFrame);
        }

        // Êí≠ÊîæÊéßÂà∂ÂäüËÉΩ
        function togglePlayback() {
            if (!appState.videoInfo || !appState.counterId) return;
            
            if (appState.isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (appState.isPlaying) return;
            
            appState.isPlaying = true;
            updatePlaybackButton();
            
            // ‰ª•ËßÜÈ¢ëÁöÑÂÆûÈôÖFPSÊí≠ÊîæÔºàÈôêÂà∂ÊúÄÈ´ò30fps‰ª•‰øùËØÅÊµÅÁïÖÊÄßÔºâ
            const playbackFPS = Math.min(appState.videoInfo.fps, 30);
            const frameInterval = 1000 / playbackFPS;
            
            appState.playbackTimer = setInterval(() => {
                if (appState.currentFrame >= appState.videoInfo.total_frames - 1) {
                    pausePlayback(); // Êí≠ÊîæÂà∞ÁªìÂ∞æËá™Âä®ÊöÇÂÅú
                    return;
                }
                
                const nextFrame = appState.currentFrame + 1;
                getFrame(nextFrame);
            }, frameInterval);
        }

        function pausePlayback() {
            if (!appState.isPlaying) return;
            
            appState.isPlaying = false;
            updatePlaybackButton();
            
            if (appState.playbackTimer) {
                clearInterval(appState.playbackTimer);
                appState.playbackTimer = null;
            }
        }

        function updatePlaybackButton() {
            // Êõ¥Êñ∞Èò∂ÊÆµ2ÁöÑÊí≠ÊîæÊåâÈíÆÂõæÊ†á
            const playIcon = document.getElementById('play-icon');
            if (playIcon) {
                playIcon.textContent = appState.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            }
            
            // Êõ¥Êñ∞Èò∂ÊÆµ3Âè≥‰æßÈ¢ÑËßàÁöÑÊí≠ÊîæÊåâÈíÆÂõæÊ†á
            const currentPlayIcon = document.getElementById('current-play-icon');
            if (currentPlayIcon) {
                currentPlayIcon.textContent = appState.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            }
            
            // Êõ¥Êñ∞ÊåâÈíÆÊ†áÈ¢ò
            const playButton = document.getElementById('play-pause-btn');
            if (playButton) {
                playButton.title = appState.isPlaying ? 'ÊöÇÂÅú (Á©∫Ê†º)' : 'Êí≠Êîæ (Á©∫Ê†º)';
            }
            
            const currentPlayButton = document.getElementById('current-play-pause-btn');
            if (currentPlayButton) {
                currentPlayButton.title = appState.isPlaying ? 'ÊöÇÂÅú (Á©∫Ê†º)' : 'Êí≠Êîæ (Á©∫Ê†º)';
            }
            
            // Âú®Êó∂Èó¥ËΩ¥Âå∫ÂüüÊòæÁ§∫Êí≠ÊîæÁä∂ÊÄÅ
            const timelineTitle = document.querySelector('.timeline-title');
            if (timelineTitle) {
                timelineTitle.textContent = appState.isPlaying ? 'VIDEO TIMELINE (Êí≠Êîæ‰∏≠)' : 'VIDEO TIMELINE';
            }
        }

        // Â∏ßÂØºËà™ÂäüËÉΩ
        function goToNextFrame(step = 1) {
            if (!appState.videoInfo) return;
            
            const targetFrame = Math.min(
                appState.currentFrame + step, 
                appState.videoInfo.total_frames - 1
            );
            
            if (targetFrame !== appState.currentFrame) {
                getFrame(targetFrame);
            }
        }

        function goToPreviousFrame(step = 1) {
            if (!appState.videoInfo) return;
            
            const targetFrame = Math.max(appState.currentFrame - step, 0);
            
            if (targetFrame !== appState.currentFrame) {
                getFrame(targetFrame);
            }
        }

        // ============ ÂàùÂßãÂåñ ============

        async function loadVideos() {
            try {
                const response = await fetch('/api/videos');
                const result = await response.json();
                
                const select = document.getElementById('video-select');
                if (!select) {
                    console.warn('Video select element not found');
                    return;
                }
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                select.innerHTML = '<option value="">ÈÄâÊã©ËßÜÈ¢ë...</option>';
                
                // ÂàÜÁªÑÊòæÁ§∫ËßÜÈ¢ë
                const uploadedVideos = result.data.videos.filter(v => v.type === 'uploaded');
                const presetVideos = result.data.videos.filter(v => v.type === 'preset');
                
                // Ê∑ªÂä†‰∏ä‰º†ÁöÑËßÜÈ¢ë
                if (uploadedVideos.length > 0) {
                    const uploadedGroup = document.createElement('optgroup');
                    uploadedGroup.label = 'üìÅ Â∑≤‰∏ä‰º†ÁöÑËßÜÈ¢ë';
                    
                    uploadedVideos.forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.path;
                        option.textContent = `${video.name} (${formatFileSize(video.size)})`;
                        uploadedGroup.appendChild(option);
                    });
                    
                    select.appendChild(uploadedGroup);
                }
                
                // Ê∑ªÂä†È¢ÑËÆæËßÜÈ¢ë
                if (presetVideos.length > 0) {
                    const presetGroup = document.createElement('optgroup');
                    presetGroup.label = 'üé¨ Á§∫‰æãËßÜÈ¢ë';
                    
                    presetVideos.forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.path;
                        option.textContent = `${video.name} (${formatFileSize(video.size)})`;
                        presetGroup.appendChild(option);
                    });
                    
                    select.appendChild(presetGroup);
                }
                
            } catch (error) {
                showMessage(`Âä†ËΩΩËßÜÈ¢ëÂàóË°®Â§±Ë¥•: ${error}`, 'error');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        async function initCounter() {
            try {
                const videoSelect = document.getElementById('video-select');
                const minLapTimeInput = document.getElementById('min-lap-time');
                
                if (!videoSelect || !minLapTimeInput) {
                    showMessage('ÁïåÈù¢Êú™Ê≠£Á°ÆÂàùÂßãÂåñ', 'error');
                    return;
                }
                
                const videoPath = videoSelect.value;
                const minLapTime = parseFloat(minLapTimeInput.value);

                if (!videoPath) {
                    showMessage('ËØ∑ÈÄâÊã©ËßÜÈ¢ëÊñá‰ª∂', 'error');
                    return;
                }

                setButtonLoading('btn-init', true);

                const response = await fetch('/api/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_path: videoPath, min_lap_time: minLapTime })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    appState.counterId = result.data.counter_id;
                    appState.videoInfo = result.data.video_info;

                    // Êõ¥Êñ∞ËßÜÈ¢ë‰ø°ÊÅØÊòæÁ§∫
                    setTimeout(() => {
                        const fpsElem = document.getElementById('info-fps');
                        const framesElem = document.getElementById('info-frames');
                        const durationElem = document.getElementById('info-duration');
                        const videoInfoElem = document.getElementById('video-info');
                        
                        if (fpsElem) fpsElem.textContent = result.data.video_info.fps.toFixed(2);
                        if (framesElem) framesElem.textContent = result.data.video_info.total_frames;
                        if (durationElem) durationElem.textContent = result.data.video_info.formatted_duration;
                        if (videoInfoElem) videoInfoElem.classList.remove('hidden');
                    }, 100);

                    // ËøõÂÖ•Èò∂ÊÆµ2
                    transitionToPhase(2);
                    await loadFirstFrame();

                    showMessage('ËßÜÈ¢ëÂä†ËΩΩÊàêÂäüÔºÅ', 'success');
                } else {
                    showMessage(`ÂàùÂßãÂåñÂ§±Ë¥•: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`ÈîôËØØ: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-init', false);
            }
        }

        // ============ Â∏ßÁÆ°ÁêÜ ============

        async function loadFirstFrame() {
            await getFrame(0);
        }

        async function getFrame(frameIdx) {
            try {
                const response = await fetch(`/api/frame/${appState.counterId}/${frameIdx}`);
                const result = await response.json();

                if (result.status === 'success') {
                    // Êõ¥Êñ∞Èò∂ÊÆµ2ÁöÑÈ¢ÑËßàÂõæÂÉè
                    const img = document.getElementById('frame-preview');
                    if (img) {
                        img.src = `data:image/png;base64,${result.data.image_base64}`;
                        img.style.display = 'block';
                    }

                    // Êõ¥Êñ∞Èò∂ÊÆµ3ÁöÑÂè≥‰æßÂΩìÂâçÂ∏ßÊòæÁ§∫
                    const currentImg = document.getElementById('current-frame-display');
                    if (currentImg) {
                        currentImg.src = `data:image/png;base64,${result.data.image_base64}`;
                        currentImg.style.display = 'block';
                    }

                    // Êõ¥Êñ∞ÂΩìÂâçÂ∏ßÁä∂ÊÄÅ
                    appState.currentFrame = frameIdx;
                    
                    // Êõ¥Êñ∞ÊéßÂà∂ËæìÂÖ•Ê°Ü
                    const frameNumberInput = document.getElementById('frame-number');
                    const frameTimeInput = document.getElementById('frame-time');
                    const timestampDisplay = document.getElementById('video-timestamp');
                    const currentTimestampDisplay = document.getElementById('current-video-timestamp');
                    
                    if (frameNumberInput && !appState.isPlaying) frameNumberInput.value = frameIdx;
                    if (frameTimeInput && !appState.isPlaying) frameTimeInput.value = result.data.time_sec.toFixed(2);
                    if (timestampDisplay) timestampDisplay.textContent = result.data.formatted_time;
                    if (currentTimestampDisplay) currentTimestampDisplay.textContent = result.data.formatted_time;
                    
                    // Êõ¥Êñ∞Êó∂Èó¥ËΩ¥
                    updateTimelinePosition();
                }
            } catch (error) {
                showMessage(`Âä†ËΩΩÂ∏ßÂ§±Ë¥•: ${error}`, 'error');
                // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•ÔºåÊöÇÂÅúÊí≠Êîæ
                if (appState.isPlaying) {
                    pausePlayback();
                }
            }
        }



        // Ê∑ªÂä†Ê†ºÂºèÂåñÊó∂Èó¥ÁöÑËæÖÂä©ÂáΩÊï∞
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const millis = Math.floor((seconds - Math.floor(seconds)) * 1000);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${millis.toString().padStart(3, '0')}`;
        }

        function jumpToFrame() {
            const frameNumberInput = document.getElementById('frame-number');
            if (!frameNumberInput || !appState.videoInfo) {
                showMessage('Á≥ªÁªüÊú™Â∞±Áª™', 'error');
                return;
            }
            
            const frameIdx = parseInt(frameNumberInput.value);
            if (frameIdx < 0 || frameIdx >= appState.videoInfo.total_frames) {
                showMessage('Â∏ßÂè∑Êó†Êïà', 'error');
                return;
            }
            getFrame(frameIdx);
        }

        function jumpToTime() {
            const frameTimeInput = document.getElementById('frame-time');
            if (!frameTimeInput || !appState.videoInfo) {
                showMessage('Á≥ªÁªüÊú™Â∞±Áª™', 'error');
                return;
            }
            
            const timeSec = parseFloat(frameTimeInput.value);
            const frameIdx = Math.floor(timeSec * appState.videoInfo.fps);
            getFrame(frameIdx);
        }

        // ============ ÂèÇËÄÉÂ∏ß ============

        async function setReferenceFrame() {
            // ÊöÇÂÅúÊí≠Êîæ
            if (appState.isPlaying) {
                pausePlayback();
            }
            try {
                const frameNumberInput = document.getElementById('frame-number');
                if (!frameNumberInput || !appState.videoInfo) {
                    showMessage('Á≥ªÁªüÊú™Â∞±Áª™', 'error');
                    return;
                }
                
                const frameIdx = parseInt(frameNumberInput.value);
                setButtonLoading('btn-set-ref', true);

                const response = await fetch(`/api/set-ref-frame/${appState.counterId}/${frameIdx}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    const img = document.getElementById('ref-frame-display');
                    if (img) {
                        img.src = `data:image/png;base64,${result.data.image_base64}`;
                    }

                    // Êõ¥Êñ∞ÂèÇËÄÉÂ∏ßÊó∂Èó¥Êà≥ÊòæÁ§∫
                    const refTimestamp = document.getElementById('ref-frame-timestamp');
                    if (refTimestamp && result.data.formatted_time) {
                        refTimestamp.textContent = `ÂèÇËÄÉÂ∏ß - ${result.data.formatted_time}`;
                    }

                    showMessage('ÂèÇËÄÉÂ∏ßËÆæÁΩÆÊàêÂäüÔºÅ', 'success');
                    transitionToPhase(3);
                    
                    // Âª∂ËøüÊõ¥Êñ∞ÊåáÂçóÊèêÁ§∫ÔºåÁ°Æ‰øùÈù¢ÊùøÂ∑≤ÂàáÊç¢
                    setTimeout(() => {
                        updateDynamicGuide('ÂèÇËÄÉÂ∏ßÂ∑≤ËÆæÁΩÆ', 'Áé∞Âú®ÂèØ‰ª•ÂºÄÂßãÊêúÁ¥¢Âç°‰∏ÅËΩ¶ÁöÑ‰∏ã‰∏ÄÂúà„ÄÇÁ≥ªÁªüÂ∞ÜËá™Âä®ËØÜÂà´Áõ∏‰ººÁöÑÂÜ≤Á∫øÁîªÈù¢„ÄÇ');
                    }, 300);
                } else {
                    showMessage(`ËÆæÁΩÆÂ§±Ë¥•: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`ÈîôËØØ: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-set-ref', false);
            }
        }

        // ============ ÊêúÁ¥¢ ============

        async function searchLap() {
            try {
                setButtonLoading('btn-search', true);

                const response = await fetch(`/api/search-lap/${appState.counterId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ search_range: 10 })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    displayCandidates(result.data.candidates);
                    showMessage('ÊêúÁ¥¢ÂÆåÊàêÔºÅËØ∑ÁÇπÂáªÊúÄÊé•ËøëÁöÑÂÄôÈÄâÂ∏ß', 'success');
                } else {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØËßÜÈ¢ëÁªìÊùüÁöÑÈîôËØØ
                    if (result.message && (result.message.includes('ËßÜÈ¢ëÊú´Â∞æ') || result.message.includes('ËßÜÈ¢ëÂ∑≤ÁªìÊùü') || result.message.includes('Ââ©‰ΩôÊó∂Èïø‰∏çË∂≥'))) {
                        showMessage('üèÅ ËßÜÈ¢ëÂàÜÊûêÂÆåÊàêÔºÅÂ∑≤Âà∞ËææËßÜÈ¢ëÊú´Â∞æÔºåÊó†Ê≥ïÁªßÁª≠ÊêúÁ¥¢Êõ¥Â§öÂúàÈÄü„ÄÇ', 'info');
                        updateDynamicGuide('ÂàÜÊûêÂÆåÊàê', 'ËßÜÈ¢ëÂ∑≤ÂàÜÊûêÂÆåÊØï„ÄÇÊÇ®ÂèØ‰ª•‰øùÂ≠òÂΩìÂâçÁªìÊûúÊàñÈáçÊñ∞ÂºÄÂßãÂàÜÊûê„ÄÇ');
                    } else {
                        showMessage(`ÊêúÁ¥¢Â§±Ë¥•: ${result.message}`, 'error');
                    }
                }
            } catch (error) {
                showMessage(`ÈîôËØØ: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-search', false);
            }
        }

        function displayCandidates(candidates) {
            const gallery = document.getElementById('candidates-gallery');
            const candidatesDisplay = document.getElementById('candidates-display');
            
            // ÊòæÁ§∫ÂÄôÈÄâÂ∏ßÂå∫Âüü
            if (candidatesDisplay) {
                candidatesDisplay.classList.remove('hidden');
            }
            
            gallery.innerHTML = '';

            candidates.forEach((candidate, idx) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.onclick = () => selectCandidate(candidate, item);
                
                item.innerHTML = `
                    <img src="data:image/png;base64,${candidate.image_base64}" alt="ÂÄôÈÄâÂ∏ß">
                    <div class="label">
                        <div>${candidate.formatted_time}</div>
                        <div>Áõ∏‰ººÂ∫¶: ${(candidate.similarity * 100).toFixed(1)}%</div>
                    </div>
                `;
                
                gallery.appendChild(item);
            });
            
            // Êõ¥Êñ∞ÊåáÂçóÊèêÁ§∫ - Ê†πÊçÆÊòØÂê¶ÊúâÂ∑≤Á°ÆËÆ§ÂúàÈÄüÂà§Êñ≠ÊèêÁ§∫ÂÜÖÂÆπ
            const isFirstLap = !appState.confirmedLaps || appState.confirmedLaps === 0;
            
            if (isFirstLap) {
                updateDynamicGuide('ÂÄôÈÄâÂ∏ßÂ∑≤ÁîüÊàê', 'ËØ∑ÁÇπÂáªÊúÄÊé•ËøëÁ¨¨‰∏ÄÊ¨°ÂÜ≤Á∫ø‰ΩçÁΩÆÁöÑÂÄôÈÄâÂ∏ßÔºåÈ¢ÑËßàÂ∞ÜËá™Âä®Ë∑≥ËΩ¨Âà∞ËØ•‰ΩçÁΩÆ„ÄÇ');
            } else {
                const nextLapNumber = appState.confirmedLaps + 1;
                updateDynamicGuide(`Á¨¨${nextLapNumber}ÂúàÂÄôÈÄâÂ∏ßÂ∑≤ÁîüÊàê`, 'ËØ∑ÁÇπÂáªÊúÄÊé•Ëøë‰∏ã‰∏ÄÊ¨°ÂÜ≤Á∫ø‰ΩçÁΩÆÁöÑÂÄôÈÄâÂ∏ßÔºåÈ¢ÑËßàÂ∞ÜËá™Âä®Ë∑≥ËΩ¨Âà∞ËØ•‰ΩçÁΩÆ„ÄÇ');
            }
        }

        function selectCandidate(candidate, element) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈÄâÊã©
            document.querySelectorAll('.gallery-item').forEach(item => item.classList.remove('selected'));
            
            // Ê†áËÆ∞ÂΩìÂâçÈÄâÊã©
            element.classList.add('selected');
            appState.selectedCandidate = candidate;

            // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ÂÄôÈÄâÂ∏ß
            getFrame(candidate.frame_idx);
            
            // Êõ¥Êñ∞ÊéßÂà∂Èù¢ÊùøÔºåÊòæÁ§∫Á°ÆËÆ§ÊåâÈíÆ
            updateControlPanelForConfirm();
            
            // Êõ¥Êñ∞ÊåáÂçóÊèêÁ§∫
            updateDynamicGuide('Â∑≤ÈÄâÊã©ÂÄôÈÄâÂ∏ß', `Â∑≤Ë∑≥ËΩ¨Ëá≥Á¨¨${candidate.frame_idx}Â∏ßÔºà${candidate.formatted_time}Ôºâ„ÄÇËØ∑‰ΩøÁî®Êó∂Èó¥ËΩ¥„ÄÅÈîÆÁõòÂø´Êç∑ÈîÆÊàñÂ∏ßÊéßÂà∂ËøõË°åÁ≤æÁ°ÆË∞ÉÊï¥ÔºåÁÑ∂ÂêéÁ°ÆËÆ§‰∏∫Êú¨ÂúàÁªàÁÇπ„ÄÇ`);
        }



        // ============ Á°ÆËÆ§ ============

        async function confirmCurrentFrame() {
            try {
                // ‰ΩøÁî®ÂΩìÂâçÈ¢ÑËßà‰∏≠ÁöÑÂ∏ß‰Ωú‰∏∫Á°ÆËÆ§Â∏ß
                const frameIdx = appState.currentFrame;
                
                setButtonLoading('btn-confirm-lap', true);

                const response = await fetch(`/api/confirm-lap/${appState.counterId}/${frameIdx}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    updateStatistics(result.data.statistics);
                    showMessage(`ÂúàÈÄüÂ∑≤Á°ÆËÆ§: ${result.data.formatted_lap_time}`, 'success');
                    
                    // Êõ¥Êñ∞Â∑≤Á°ÆËÆ§ÂúàÊï∞
                    appState.confirmedLaps = result.data.statistics.total_laps;
                    
                    // ÈáçÁΩÆÊêúÁ¥¢Áä∂ÊÄÅ
                    document.getElementById('candidates-gallery').innerHTML = '';
                    const candidatesDisplay = document.getElementById('candidates-display');
                    if (candidatesDisplay) {
                        candidatesDisplay.classList.add('hidden');
                    }
                    appState.selectedCandidate = null;
                    
                    // ËøîÂõûÂà∞ÊêúÁ¥¢Ê®°Âºè
                    updateControlPanel(3);
                    
                    // Êõ¥Êñ∞ÊåáÂçóÊèêÁ§∫Âπ∂Ëá™Âä®ÂºÄÂßã‰∏ã‰∏ÄÂúàÊêúÁ¥¢
                    const lapNumber = result.data.statistics.total_laps;
                    updateDynamicGuide('Ëá™Âä®ËØÜÂà´ÂÜ≤Á∫øÊó∂Âàª‰∏≠...', `Á¨¨${lapNumber}ÂúàÂ∑≤Á°ÆËÆ§Ôºà${result.data.formatted_lap_time}Ôºâ„ÄÇÊ≠£Âú®Ëá™Âä®ÊêúÁ¥¢Á¨¨${lapNumber + 1}Âúà...`);
                    
                    // Á´ãÂç≥ÂºÄÂßã‰∏ã‰∏ÄÂúàÊêúÁ¥¢
                    try {
                        // Âú®Ëá™Âä®ÊêúÁ¥¢ÊúüÈó¥Á¶ÅÁî®ÊåâÈíÆ
                        setButtonLoading('btn-search', true, 'Ê≠£Âú®Êü•ÊâæÊÇ®ÁöÑÂÜ≤Á∫øÁîªÈù¢...');
                        
                        // Â∞ùËØïÊêúÁ¥¢‰∏ã‰∏ÄÂúà
                        const searchResponse = await fetch(`/api/search-lap/${appState.counterId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ search_range: 10 })
                        });
                        
                        const searchResult = await searchResponse.json();
                        
                        if (searchResult.status === 'success') {
                            displayCandidates(searchResult.data.candidates);
                            updateDynamicGuide('ÂÄôÈÄâÂ∏ßÂ∑≤ÁîüÊàê', `Á¨¨${lapNumber + 1}ÂúàÂÄôÈÄâÂ∏ßÂ∑≤ÁîüÊàêÔºåËØ∑ÈÄâÊã©ÊúÄÊé•ËøëÁöÑÁªàÁÇπÂ∏ß„ÄÇ`);
                        } else {
                            // Ê£ÄÊü•ÊòØÂê¶ÊòØËßÜÈ¢ëÁªìÊùü
                            if (searchResult.message && (searchResult.message.includes('ËßÜÈ¢ëÊú´Â∞æ') || searchResult.message.includes('ËßÜÈ¢ëÂ∑≤ÁªìÊùü') || searchResult.message.includes('Ââ©‰ΩôÊó∂Èïø‰∏çË∂≥'))) {
                                updateDynamicGuide('üèÅ ÂàÜÊûêÂÆåÊàê', `ËßÜÈ¢ëÂàÜÊûêÂÆåÊØïÔºÅÂÖ±ÂÆåÊàê${lapNumber}ÂúàÂàÜÊûê„ÄÇÂèØ‰ª•‰øùÂ≠òÁªìÊûúÊàñÈáçÊñ∞ÂºÄÂßãÂàÜÊûê„ÄÇ`);
                                showMessage('üèÅ ËßÜÈ¢ëÂàÜÊûêÂÆåÊàêÔºÅ', 'info');
                            } else {
                                updateDynamicGuide('ÊêúÁ¥¢ÂÆåÊàê', `Â∑≤ÂÆåÊàê${lapNumber}ÂúàÂàÜÊûê„ÄÇÂèØ‰ª•ÊâãÂä®ÊêúÁ¥¢Êõ¥Â§öÂúàÈÄüÊàñ‰øùÂ≠òÂΩìÂâçÁªìÊûú„ÄÇ`);
                            }
                        }
                    } catch (error) {
                        updateDynamicGuide('ÊêúÁ¥¢ÂÆåÊàê', `Â∑≤ÂÆåÊàê${lapNumber}ÂúàÂàÜÊûê„ÄÇÂèØ‰ª•ÊâãÂä®ÊêúÁ¥¢Êõ¥Â§öÂúàÈÄüÊàñ‰øùÂ≠òÂΩìÂâçÁªìÊûú„ÄÇ`);
                    } finally {
                        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                        setButtonLoading('btn-search', false);
                    }
                } else {
                    showMessage(`Á°ÆËÆ§Â§±Ë¥•: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`ÈîôËØØ: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-confirm-lap', false);
            }
        }

        function cancelSelection() {
            // Ê∏ÖÈô§ÈÄâÊã©Áä∂ÊÄÅ
            document.querySelectorAll('.gallery-item').forEach(item => item.classList.remove('selected'));
            appState.selectedCandidate = null;
            
            // ÈöêËóèÂÄôÈÄâÂ∏ßÊòæÁ§∫
            const candidatesDisplay = document.getElementById('candidates-display');
            if (candidatesDisplay) {
                candidatesDisplay.classList.add('hidden');
            }
            
            // ËøîÂõûÂà∞ÊêúÁ¥¢Ê®°Âºè
            updateControlPanel(3);
            
            // Êõ¥Êñ∞ÊåáÂçóÊèêÁ§∫
            updateDynamicGuide('Â∑≤ÂèñÊ∂àÈÄâÊã©', 'ËØ∑ÈáçÊñ∞ÊêúÁ¥¢ÂúàÈÄüÊàñ‰ªéÂÄôÈÄâÂ∏ß‰∏≠ÈÄâÊã©ÂêàÈÄÇÁöÑÁªàÁÇπÂ∏ß„ÄÇ');
        }



        function updateStatistics(stats) {
            const container = document.getElementById('stats-container');
            
            if (stats.total_laps === 0) {
                container.innerHTML = '<div class="stats-placeholder">ÊöÇÊó†Êï∞ÊçÆ</div>';
                return;
            }

            let html = `
                <div class="compact-stats-grid">
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">ÊÄªÂúàÊï∞</div>
                        <div class="compact-stat-value">${stats.total_laps}</div>
                    </div>
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">ÊúÄÂø´Âúà</div>
                        <div class="compact-stat-value">${stats.best_lap}</div>
                    </div>
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">ÊúÄÊÖ¢Âúà</div>
                        <div class="compact-stat-value">${stats.worst_lap}</div>
                    </div>
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">Âπ≥ÂùáÂúà</div>
                        <div class="compact-stat-value">${stats.average_lap}</div>
                    </div>
                </div>
                <div class="compact-laps-list">
            `;

            stats.laps.forEach(lap => {
                const isLatest = lap.lap_number === stats.total_laps;
                html += `
                    <div class="compact-lap-item ${isLatest ? 'latest-lap' : ''}">
                        <span>Á¨¨ ${lap.lap_number} Âúà</span>
                        <span style="color: ${isLatest ? '#10b981' : '#3b82f6'}; font-weight: 600;">${lap.formatted_time}</span>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ============ ‰øùÂ≠ò ============

        async function saveResults() {
            try {
                setButtonLoading('btn-save', true);

                const response = await fetch(`/api/save-results/${appState.counterId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showMessage('‚úÖ ÁªìÊûúÂ∑≤‰øùÂ≠òÔºÅ', 'success');
                } else {
                    showMessage(`‰øùÂ≠òÂ§±Ë¥•: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`ÈîôËØØ: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-save', false);
            }
        }

        // ============ Â∑•ÂÖ∑ÂáΩÊï∞ ============

        // Âä®ÊÄÅÊõ¥Êñ∞ÊåáÂçóÊèêÁ§∫
        function updateDynamicGuide(title, message) {
            const guideContent = document.querySelector('.guide-content');
            if (!guideContent) return;
            
            const h5 = guideContent.querySelector('h5');
            const p = guideContent.querySelector('p');
            
            if (h5 && p) {
                // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
                guideContent.style.opacity = '0.5';
                guideContent.style.transform = 'scale(0.98)';
                
                setTimeout(() => {
                    h5.textContent = title;
                    p.textContent = message;
                    guideContent.style.opacity = '1';
                    guideContent.style.transform = 'scale(1)';
                    guideContent.style.transition = 'all 0.3s ease';
                }, 150);
            }
        }

        // Êõ¥Êñ∞ÊéßÂà∂Èù¢Êùø‰ª•ÊòæÁ§∫Á°ÆËÆ§ÈÄâÈ°π
        function updateControlPanelForConfirm() {
            const panel = document.getElementById('control-panel');
            
            // ‰øùÊåÅÂΩìÂâçÈò∂ÊÆµÊ†∑Âºè
            const currentPhase = panel.classList.contains('phase-1-guide') ? 1 : 
                               panel.classList.contains('phase-2-guide') ? 2 : 3;
            
            panel.innerHTML = `
                <div class="guide-box">
                    <div class="guide-content">
                        <h5>Â∑≤ÈÄâÊã©ÂÄôÈÄâÂ∏ß</h5>
                        <p>ÂΩìÂâçÈ¢ÑËßàÂ∑≤Ë∑≥ËΩ¨Ëá≥ÂÄôÈÄâÂ∏ß‰ΩçÁΩÆ„ÄÇËØ∑‰ΩøÁî®‰ª•‰∏ãÊñπÂºèËøõË°åÁ≤æÁ°ÆË∞ÉÊï¥ÔºåÁÑ∂ÂêéÁ°ÆËÆ§‰∏∫Êú¨ÂúàÁªàÁÇπ„ÄÇ</p>
                        <div class="guide-tips">
                            <div class="tip">üéÆ ÈîÆÁõòÊéßÂà∂Ôºö‚Üê‚ÜíÈÄêÂ∏ßÔºåShift+‚Üê‚ÜíË∑≥5Â∏ß</div>
                            <div class="tip">üñ±Ô∏è ÁÇπÂáªÊó∂Èó¥ËΩ¥Âø´ÈÄüË∑≥ËΩ¨</div>
                            <div class="tip">üìù ‰ΩøÁî®Â∏ßÂè∑/Êó∂Èó¥ËæìÂÖ•Ê°ÜÁ≤æÁ°ÆÂÆö‰Ωç</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <h4 class="panel-title">Â∏ßÊéßÂà∂</h4>
                    </div>
                    <div class="panel-content">
                        <div class="form-group">
                            <label>Â∏ßÂè∑</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="frame-number" value="${appState.currentFrame}" min="0" style="flex: 1;">
                                <button class="btn-secondary btn-small" onclick="jumpToFrame()">Ë∑≥ËΩ¨</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Êó∂Èó¥(Áßí)</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="frame-time" value="${(appState.currentFrame / appState.videoInfo.fps).toFixed(2)}" step="0.1" min="0" style="flex: 1;">
                                <button class="btn-secondary btn-small" onclick="jumpToTime()">Ë∑≥ËΩ¨</button>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 16px;">
                            <button class="btn-primary" id="btn-confirm-lap" onclick="confirmCurrentFrame()">
                                Á°ÆËÆ§‰∏∫ÂÜ≤Á∫øÊó∂Âàª
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function transitionToPhase(phase) {
            // ÊöÇÂÅúÊí≠ÊîæÔºàÂ¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºâ
            if (appState.isPlaying) {
                pausePlayback();
            }
            
            // Êõ¥Êñ∞Èò∂ÊÆµÊåáÁ§∫
            for (let i = 1; i <= 3; i++) {
                const phaseDiv = document.getElementById(`phase-${i}`);
                phaseDiv.classList.remove('active', 'completed');
                if (i < phase) {
                    phaseDiv.classList.add('completed');
                } else if (i === phase) {
                    phaseDiv.classList.add('active');
                }
            }

            // Êõ¥Êñ∞ÂÜÖÂÆπÊòæÁ§∫
            document.getElementById('phase1-content').classList.toggle('hidden', phase !== 1);
            document.getElementById('phase2-content').classList.toggle('hidden', phase !== 2);
            document.getElementById('phase3-content').classList.toggle('hidden', phase !== 3);
            
            // Êõ¥Êñ∞ÊéßÂà∂Èù¢Êùø
            updateControlPanel(phase);
            
            // ÊòæÁ§∫/ÈöêËóèÁõ∏ÂÖ≥Âå∫Âüü - ÂÄôÈÄâÂ∏ßÁé∞Âú®Âú®phase3-contentÂÜÖÈÉ®ÁÆ°ÁêÜ
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            // ÂàõÂª∫toastÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÂõæÊ†á
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '‚úÖ';
                    break;
                case 'error':
                    icon = '‚ùå';
                    break;
                case 'info':
                default:
                    icon = '‚ÑπÔ∏è';
                    break;
            }
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                ${message}
                <button class="toast-close" onclick="closeToast(this)">&times;</button>
            `;
            
            // Ê∑ªÂä†Âà∞ÂÆπÂô®
            container.appendChild(toast);
            
            // Ëß¶ÂèëÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Ëá™Âä®ÂÖ≥Èó≠ÔºàÈîôËØØÊ∂àÊÅØÊåÅÁª≠Êõ¥ÈïøÊó∂Èó¥Ôºâ
            const duration = type === 'error' ? 8000 : 4000;
            setTimeout(() => {
                closeToast(toast.querySelector('.toast-close'));
            }, duration);
        }

        function closeToast(closeBtn) {
            const toast = closeBtn.parentElement;
            toast.classList.remove('show');
            toast.style.animation = 'slideOutToast 0.3s ease forwards';
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        function setButtonLoading(buttonId, loading, customText = null) {
            const btn = document.getElementById(buttonId);
            if (!btn) {
                console.warn(`Button with id "${buttonId}" not found`);
                return;
            }
            
            btn.disabled = loading;
            
            if (loading) {
                // ‰øùÂ≠òÂéüÂßãÊñáÊú¨
                if (!btn.dataset.originalText) {
                    btn.dataset.originalText = btn.innerHTML;
                }
                const loadingText = customText || 'Âä†ËΩΩ‰∏≠...';
                btn.innerHTML = `<span class="loading"></span> ${loadingText}`;
            } else {
                // ÊÅ¢Â§çÂéüÂßãÊñáÊú¨
                if (btn.dataset.originalText) {
                    btn.innerHTML = btn.dataset.originalText;
                }
            }
        }

        // ============ ÈîÆÁõòÊéßÂà∂ ============

        function setupKeyboardControls() {
            document.addEventListener('keydown', (event) => {
                // Â¶ÇÊûúÁî®Êà∑Ê≠£Âú®ËæìÂÖ•Ê°Ü‰∏≠ËæìÂÖ•Ôºå‰∏çÂ§ÑÁêÜÂø´Êç∑ÈîÆ
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                const handled = handleKeyboardShortcut(event);
                if (handled) {
                    event.preventDefault();
                }
            });
        }

        function handleKeyboardShortcut(event) {
            const { code, shiftKey, ctrlKey, altKey } = event;
            
            // Âè™Âú®ÊúâËßÜÈ¢ëÂä†ËΩΩÊó∂Â§ÑÁêÜÂø´Êç∑ÈîÆ
            if (!appState.videoInfo || !appState.counterId) {
                return false;
            }
            
            switch (code) {
                case 'Space':
                    // Á©∫Ê†ºÈîÆÔºöÊí≠Êîæ/ÊöÇÂÅú
                    togglePlayback();
                    return true;
                    
                case 'ArrowLeft':
                    // Â∑¶ÁÆ≠Â§¥Ôºö‰∏ä‰∏ÄÂ∏ß (Shift+Â∑¶ÁÆ≠Â§¥ÔºöÂêëÂâçË∑≥5Â∏ß)
                    if (shiftKey) {
                        goToPreviousFrame(5);
                    } else {
                        goToPreviousFrame(1);
                    }
                    return true;
                    
                case 'ArrowRight':
                    // Âè≥ÁÆ≠Â§¥Ôºö‰∏ã‰∏ÄÂ∏ß (Shift+Âè≥ÁÆ≠Â§¥ÔºöÂêëÂêéË∑≥5Â∏ß)
                    if (shiftKey) {
                        goToNextFrame(5);
                    } else {
                        goToNextFrame(1);
                    }
                    return true;
                    
                case 'Home':
                    // HomeÈîÆÔºöË∑≥ËΩ¨Âà∞ÂºÄÂßã
                    getFrame(0);
                    return true;
                    
                case 'End':
                    // EndÈîÆÔºöË∑≥ËΩ¨Âà∞ÁªìÊùü
                    getFrame(appState.videoInfo.total_frames - 1);
                    return true;
                    
                case 'KeyJ':
                    // JÈîÆÔºöÂêëÂâçË∑≥10Â∏ß
                    goToPreviousFrame(10);
                    return true;
                    
                case 'KeyL':
                    // LÈîÆÔºöÂêëÂêéË∑≥10Â∏ß  
                    goToNextFrame(10);
                    return true;
                    
                case 'KeyK':
                    // KÈîÆÔºöÊí≠Êîæ/ÊöÇÂÅú (Â§áÁî®)
                    togglePlayback();
                    return true;
                    
                default:
                    return false;
            }
        }

        // ============ Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩ ============

        function initFileUpload() {
            const uploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('file-input');
            const browseLink = document.getElementById('browse-files');

            if (!uploadArea || !fileInput || !browseLink) {
                console.warn('File upload elements not found');
                return;
            }

            // ÁÇπÂáªÊµèËßàÊñá‰ª∂
            browseLink.addEventListener('click', (e) => {
                e.preventDefault();
                fileInput.click();
            });

            // ÁÇπÂáª‰∏ä‰º†Âå∫Âüü‰πüËß¶ÂèëÊñá‰ª∂ÈÄâÊã©
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // Êñá‰ª∂ÈÄâÊã©
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            // ÊãñÊãΩ‰∫ã‰ª∂
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        function validateVideoFile(file) {
            const allowedTypes = ['video/mp4', 'video/avi', 'video/quicktime'];
            const maxSize = 500 * 1024 * 1024; // 500MB

            if (!allowedTypes.includes(file.type)) {
                showMessage('Âè™ÊîØÊåÅ MP4, AVI, MOV Ê†ºÂºèÁöÑËßÜÈ¢ëÊñá‰ª∂', 'error');
                return false;
            }

            if (file.size > maxSize) {
                showMessage('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá 500MB', 'error');
                return false;
            }

            return true;
        }

        function handleFileUpload(file) {
            if (!validateVideoFile(file)) {
                return;
            }

            showUploadProgress(true);
            updateUploadProgress(0, 'ÂáÜÂ§á‰∏ä‰º†...');

            const formData = new FormData();
            formData.append('video', file);

            const xhr = new XMLHttpRequest();

            // ‰∏ä‰º†ËøõÂ∫¶
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    updateUploadProgress(percentComplete, `‰∏ä‰º†‰∏≠ ${Math.round(percentComplete)}%`);
                }
            });

            // ‰∏ä‰º†ÂÆåÊàê
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    try {
                        const result = JSON.parse(xhr.responseText);
                        if (result.status === 'success') {
                            updateUploadProgress(100, '‰∏ä‰º†ÂÆåÊàê');
                            showMessage('ËßÜÈ¢ë‰∏ä‰º†ÊàêÂäüÔºÅ', 'success');
                            
                            // Âà∑Êñ∞ËßÜÈ¢ëÂàóË°®Âπ∂Ëá™Âä®ÈÄâÊã©Êñ∞‰∏ä‰º†ÁöÑËßÜÈ¢ë
                            setTimeout(async () => {
                                await loadVideos();
                                const videoSelect = document.getElementById('video-select');
                                if (videoSelect && result.data.file_path) {
                                    videoSelect.value = result.data.file_path;
                                }
                                showUploadProgress(false);
                            }, 1000);
                        } else {
                            showMessage(`‰∏ä‰º†Â§±Ë¥•: ${result.message}`, 'error');
                            showUploadProgress(false);
                        }
                    } catch (error) {
                        showMessage('‰∏ä‰º†ÂìçÂ∫îËß£ÊûêÂ§±Ë¥•', 'error');
                        showUploadProgress(false);
                    }
                } else {
                    showMessage('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                    showUploadProgress(false);
                }
            });

            // ‰∏ä‰º†ÈîôËØØ
            xhr.addEventListener('error', () => {
                showMessage('‰∏ä‰º†Âá∫ÈîôÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
                showUploadProgress(false);
            });

            // ÂºÄÂßã‰∏ä‰º†
            xhr.open('POST', '/api/upload');
            xhr.send(formData);
        }

        function showUploadProgress(show) {
            const progressDiv = document.getElementById('upload-progress');
            if (progressDiv) {
                progressDiv.style.display = show ? 'flex' : 'none';
            }
        }

        function updateUploadProgress(percent, text) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            if (progressFill) {
                progressFill.style.width = `${percent}%`;
            }
            
            if (progressText) {
                progressText.textContent = text;
            }
        }

        // ============ ÂàùÂßãÂåñÂ∫îÁî® ============

        window.addEventListener('DOMContentLoaded', () => {
            // ÂàùÂßãÂåñ‰∏∫Èò∂ÊÆµ1
            transitionToPhase(1);
            
            // ËÆæÁΩÆÈîÆÁõòÊéßÂà∂
            setupKeyboardControls();
            
            // ÂàùÂßãÂåñÊñá‰ª∂‰∏ä‰º†
            initFileUpload();
        });
    </script>
</body>
</html>
