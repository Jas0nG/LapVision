<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸï¸ LapVision </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f0f0f;
            color: #e5e5e5;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #0f0f0f;
        }

        /* ä¸“ä¸šå‰ªè¾‘è½¯ä»¶é¡¶éƒ¨å·¥å…·æ  */
        .top-toolbar {
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border-bottom: 1px solid #333;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .app-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .toolbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .preview-section {
            flex: 1;
            display: flex;
            background: #272727;
            border-bottom: 1px solid #333;
            min-height: 400px;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            height: 100%; /* ç¡®ä¿å¡«æ»¡çˆ¶å…ƒç´ é«˜åº¦ */
        }

        /* æ—¶é—´è½´åŒºåŸŸ */
        .timeline-section {
            background: #202020;
            border-top: 1px solid #333;
            padding: 20px;
            min-height: 200px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            width: 500px;
            background: #202020;
            border-left: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1em;
            color: #9ca3af;
        }

        /* ä¸“ä¸šæ—¶é—´è½´æ ·å¼ */
        .timeline-container {
            background: #222222;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            border: 1px solid #333;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1px;
        }

        .timeline-title {
            font-size: 0.9em;
            font-weight: 500;
            color: #ccc;
        }

        .timeline-right-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .timeline-info {
            font-size: 0.8em;
            color: #888;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .timeline-shortcuts {
            display: flex;
            gap: 12px;
            opacity: 0.6;
        }

        .timeline-shortcuts .shortcut {
            font-size: 0.7em;
            color: #666;
            font-family: 'Monaco', 'Menlo', monospace;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-track {
            position: relative;
            height: 60px;
            background: #0a0a0a;
            border-radius: 4px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .timeline-ruler {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .timeline-ruler-marks {
            position: relative;
            height: 100%;
            background-image: repeating-linear-gradient(
                90deg,
                #444 0px,
                #444 1px,
                transparent 1px,
                transparent 50px
            );
        }

        .timeline-playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff4444;
            box-shadow: 0 0 6px rgba(255, 68, 68, 0.6);
            z-index: 10;
            transition: left 0.1s ease;
        }

        .timeline-playhead::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -6px;
            width: 14px;
            height: 14px;
            background: #ff4444;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 68, 68, 0.8);
        }

        .timeline-waveform {
            position: absolute;
            top: 21px;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(59, 130, 246, 0.1) 0%,
                rgba(59, 130, 246, 0.3) 50%,
                rgba(59, 130, 246, 0.1) 100%
            );
            background-size: 4px 100%;
        }

        /* é¢æ¿æ ·å¼ */
        .panel {
            background: linear-gradient(180deg, #1f1f1f 0%, #1a1a1a 100%);
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #333;
            background: #222;
            border-radius: 7px 7px 0 0;
        }

        .panel-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .panel-content {
            padding: 16px;
        }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        /* ä¸“ä¸šè¡¨å•æ§ä»¶ */
        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85em;
            font-weight: 500;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #e5e5e5;
            font-size: 0.9em;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
            background: #111;
        }

        /* ä¸“ä¸šæŒ‰é’® */
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white;
            font-size: 1.2em;
            padding: 12px 24px;
            display: block;
            text-align: center;
            margin: 0 auto;
            border-color: #1e3a8a;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: #222;
            color: #ccc;
            border-color: #444;
        }

        .btn-secondary:hover {
            background: #333;
            border-color: #555;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .btn-icon {
            padding: 8px;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* ä¸“ä¸šè§†é¢‘é¢„è§ˆ */
        .video-preview {
            position: relative;
            max-width: 800px;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        .video-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .video-preview:hover .video-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        .playback-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .playback-controls button {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .playback-controls button:hover {
            background: rgba(255, 107, 53, 0.9);
            border-color: #ff6b35;
            transform: scale(1.1);
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 16px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .video-timestamp {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .keyboard-hints {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .keyboard-hints .hint {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(0, 0, 0, 0.6);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            text-shadow: none;
        }

        .preview-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            background: #272727;
            border: 5px dashed #333;
            border-radius: 8px;
            color: #666;
            font-size: 1.1em;
            aspect-ratio: 16 / 9;
        }

        /* æ»‘å— */
        .slider-container {
            margin: 20px 0;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #3f4857;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* ç”»å»Š */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .gallery-item {
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .gallery-item:hover {
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .gallery-item.selected {
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .gallery-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
        }

        .gallery-item .label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: #e0e0e0;
            padding: 4px 8px;
            font-size: 0.75em;
            text-align: center;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .stat-box {
            background: #1e1e2e;
            border: 1px solid #3f4857;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #3b82f6;
        }

        /* æµ®åŠ¨é€šçŸ¥æç¤º */
        .toast-container {
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 1000;
            pointer-events: none;
        }

        .toast {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transform: translateX(-100%) scale(0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }

        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0) scale(1);
        }

        .toast.success {
            background: rgba(16, 185, 129, 0.15);
            color: #a7f3d0;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .toast.success::before {
            background: #10b981;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .toast.error::before {
            background: #ef4444;
        }

        .toast.info {
            background: rgba(6, 182, 212, 0.15);
            color: #a5f3fc;
            border-color: rgba(6, 182, 212, 0.3);
        }

        .toast.info::before {
            background: #06b6d4;
        }

        .toast-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.1em;
        }

        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: currentColor;
            opacity: 0.6;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: opacity 0.2s ease;
        }

        .toast-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes slideInToast {
            from {
                opacity: 0;
                transform: translateX(100%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes slideOutToast {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateX(100%) scale(0.9);
            }
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* é˜¶æ®µæŒ‡ç¤º */
        .phase-indicator {
            display: flex;
            gap: 8px;
        }

        .phase {
            padding: 4px 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #999;
            font-size: 0.75em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .phase.active {
            background: #ff6b35;
            border-color: #ff6b35;
            color: white;
        }

        .phase.completed {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #3b82f6;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1e1e2e;
            color: #e0e0e0;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #3b82f6;
            font-size: 0.9em;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* ç¬¬äºŒæ­¥ç°ä»£åŒ–è®¾è®¡ */
        #phase2-card {
            text-align: center;
        }

        #phase2-card .control-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        #phase2-card .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 140px;
        }

        #phase2-card .control-item label {
            font-size: 0.85em;
            margin-bottom: 8px;
            color: #d0d0d0;
            font-weight: 500;
        }

        #phase2-card .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1e1e2e;
            border: 1px solid #3f4857;
            border-radius: 8px;
            padding: 4px;
            width: 140px;
        }

        #phase2-card .compact-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 12px;
            color: #e0e0e0;
            font-size: 0.9em;
            min-width: 0;
        }

        #phase2-card .compact-input:focus {
            outline: none;
            box-shadow: none;
        }

        #phase2-card .input-group:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        #phase2-card .compact-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        #phase2-card .compact-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        /* ç°ä»£åŒ–æ»‘å—è®¾è®¡ */
        #phase2-card .modern-slider-container {
            margin: 32px 0;
            padding: 0 8px;
        }

        #phase2-card .slider-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            font-weight: 500;
            color: #3b82f6;
        }

        #phase2-card .slider-wrapper {
            position: relative;
            background: #2d3748;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #3f4857;
        }

        #phase2-card .modern-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #3f4857 0%, #3f4857 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin: 12px 0;
        }

        #phase2-card .modern-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            cursor: pointer;
            border: 3px solid #1e1e2e;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
        }

        #phase2-card .modern-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        #phase2-card .modern-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            cursor: pointer;
            border: 3px solid #1e1e2e;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        #phase2-card .slider-track {
            position: absolute;
            top: 50%;
            left: 20px;
            right: 20px;
            height: 8px;
            background: #3f4857;
            border-radius: 4px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        #phase2-card .slider-progress {
            position: absolute;
            top: 50%;
            left: 20px;
            height: 8px;
            background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
            border-radius: 4px;
            transform: translateY(-50%);
            width: 0%;
            transition: width 0.1s ease;
            pointer-events: none;
        }

        #phase2-card .frame-info {
            margin-top: 16px;
            padding: 12px 16px;
            background: #1e1e2e;
            border: 1px solid #3f4857;
            border-radius: 8px;
            color: #9ca3af;
            font-size: 0.9em;
            font-family: 'Monaco', 'Menlo', monospace;
            text-align: center;
        }

        #phase2-card .button-group {
            justify-content: center;
            margin-top: 32px;
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        /* è¿›åº¦æŒ‡ç¤º */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #3f4857;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* æ“ä½œæŒ‡å—æ ·å¼ */
        .guide-box {
            background: linear-gradient(135deg, #ffffff 0%, #101f4e 100%);
            border: 1px solid #ececec;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .guide-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffffff, #06b6d4, #3b82f6);
            border-radius: 8px;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite;
        }

        @keyframes borderGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .guide-box .guide-icon {
            font-size: 2em;
            text-align: center;
            margin-bottom: 12px;
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
        }

        .guide-content h5 {
            color: #fff;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .guide-content p {
            color: #e2e8f0;
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 12px;
            text-align: center;
        }

        .guide-steps {
            margin-top: 12px;
        }

        .guide-steps .step {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .guide-steps .step:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(4px);
        }

        .guide-steps .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #ff6b35;
            color: white;
            border-radius: 50%;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .guide-steps .step span:not(.step-number) {
            color: #f1f5f9;
            font-size: 0.85em;
        }

        .guide-tips {
            margin-top: 12px;
        }

        .guide-tips .tip {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 4px;
            color: #cbd5e1;
            font-size: 0.8em;
            line-height: 1.4;
        }

        .guide-tips .tip::before {
            content: attr(data-emoji);
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* ä¸ºä¸åŒé˜¶æ®µä½¿ç”¨ä¸åŒçš„ä¸»è‰²è°ƒ */
        .phase-1-guide .guide-box {
            background: linear-gradient(135deg, #024731 0%, #084f37 100%);
            border-color: #024731;
        }

        .phase-1-guide .guide-box::before {
            background: linear-gradient(45deg, #064e3b, #065f46, #064e3b);
        }

        .phase-2-guide .guide-box {
            background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
            border-color: #2563eb;
        }

        .phase-2-guide .guide-box::before {
            background: linear-gradient(45deg, #2563eb, #3b82f6, #2563eb);
        }

        .phase-3-guide .guide-box {
            background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%);
            border-color: #6d28d9;
        }

        .phase-3-guide .guide-box::before {
            background: linear-gradient(45deg, #6d28d9, #8b5cf6, #6d28d9);
        }

        /* é˜¶æ®µ3ç´§å‡‘å¸ƒå±€æ ·å¼ */
        .phase3-main-layout {
            display: flex;
            gap: 16px;
            height: 100%;
            width: 100%;
            align-items: flex-start; /* æ”¹ä¸ºé¡¶éƒ¨å¯¹é½ï¼Œé¿å…æ‹‰ä¼¸ */
            position: absolute; /* ä½¿ç”¨ç»å¯¹å®šä½ç¡®ä¿å›ºå®šé«˜åº¦ */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .phase3-preview-area {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%; /* å›ºå®šé«˜åº¦ */
            overflow-y: auto; /* å…è®¸å†…å®¹æ»šåŠ¨ */
        }

        .phase3-stats-area {
            flex: 0 0 280px; /* å›ºå®šå®½åº¦ï¼Œä¸ä¼¸ç¼© */
            min-width: 240px;
            max-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%; /* å›ºå®šå¡«æ»¡å®¹å™¨é«˜åº¦ */
            position: relative; /* ç¡®ä¿å­å…ƒç´ æ­£ç¡®å®šä½ */
        }

        /* ç´§å‡‘åŒç”»é¢é¢„è§ˆ */
        .compact-dual-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
            height: 350px; /* è¿›ä¸€æ­¥å¢å¤§é«˜åº¦ */
        }

        .compact-preview-half {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .compact-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #222;
            border-bottom: 1px solid #333;
        }

        .preview-label {
            font-size: 0.75em;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-time {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.7em;
            color: #ff6b35;
            font-weight: 500;
        }

        .compact-video-preview {
            position: relative;
            background: #000;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compact-video-preview img {
            width: 100%;
            height: 100%;
            max-height: none;
            object-fit: contain;
            display: block;
        }

        .compact-video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .compact-video-preview:hover .compact-video-overlay {
            opacity: 1;
        }

        .compact-playback-controls {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compact-play-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .compact-play-btn:hover {
            background: rgba(255, 107, 53, 0.9);
            border-color: #ff6b35;
            transform: scale(1.1);
        }

        /* å€™é€‰å¸§æ˜¾ç¤º */
        .candidates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px 6px 0 0;
            margin-bottom: 0;
        }

        .candidates-header h4 {
            margin: 0;
            font-size: 0.8em;
            color: #fff;
            font-weight: 600;
        }

        .candidates-hint {
            font-size: 0.7em;
            color: #999;
        }

        .compact-candidates-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 180px; /* å‡å°æœ€å¤§é«˜åº¦ */
            overflow-y: auto;
        }

        .compact-candidates-gallery .gallery-item {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .compact-candidates-gallery .gallery-item:hover {
            border-color: #3b82f6;
            transform: scale(1.02);
        }

        .compact-candidates-gallery .gallery-item.selected {
            border-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }

        .compact-candidates-gallery .gallery-item img {
            width: 100%;
            height: 100px; /* å‡å°å›¾ç‰‡é«˜åº¦ */
            object-fit: cover;
        }

        .compact-candidates-gallery .gallery-item .label {
            padding: 4px 6px;
            background: rgba(0, 0, 0, 0.8);
            color: #e0e0e0;
            font-size: 0.65em;
            text-align: center;
            line-height: 1.2;
        }

        /* ç´§å‡‘ç»Ÿè®¡é¢æ¿ */
        .compact-stats-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%; /* ç¡®ä¿å¡«æ»¡å®¹å™¨é«˜åº¦ */
            min-height: 0; /* å…è®¸å†…å®¹æ”¶ç¼© */
        }

        .compact-stats-header {
            padding: 10px 12px;
            background: #222;
            border-bottom: 1px solid #333;
        }

        .compact-stats-header h4 {
            margin: 0;
            font-size: 0.8em;
            color: #fff;
            font-weight: 600;
        }

        .compact-stats-content {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
        }

        .stats-placeholder {
            color: #666;
            text-align: center;
            font-size: 0.8em;
            padding: 20px 0;
        }

        /* ç®€åŒ–çš„ç»Ÿè®¡æ˜¾ç¤º */
        .compact-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .compact-stat-box {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
        }

        .compact-stat-label {
            font-size: 0.65em;
            color: #999;
            margin-bottom: 4px;
        }

        .compact-stat-value {
            font-size: 0.8em;
            font-weight: 600;
            color: #3b82f6;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .compact-laps-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .compact-lap-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-bottom: 1px solid #333;
            font-size: 0.75em;
        }

        .compact-lap-item:last-child {
            border-bottom: none;
        }

        .compact-lap-item.latest-lap {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .phase3-main-layout {
                flex-direction: column;
                position: relative; /* åœ¨å°å±å¹•ä¸Šä½¿ç”¨ç›¸å¯¹å®šä½ */
                height: auto;
            }
            
            .phase3-stats-area {
                flex: 0 0 auto; /* åœ¨å‚ç›´å¸ƒå±€æ—¶ä½¿ç”¨è‡ªåŠ¨é«˜åº¦ */
                max-width: none;
                min-width: 0;
                height: auto;
                min-height: 300px; /* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿å¯ç”¨æ€§ */
            }
            
            .phase3-preview-area {
                height: auto; /* åœ¨å‚ç›´å¸ƒå±€æ—¶ä½¿ç”¨è‡ªåŠ¨é«˜åº¦ */
                overflow-y: visible;
            }
            
            .compact-dual-preview {
                height: 250px;
            }
            
            .timeline-shortcuts {
                gap: 8px;
            }
            
            .timeline-shortcuts .shortcut {
                font-size: 0.65em;
                padding: 1px 4px;
            }
        }

        @media (max-width: 768px) {
            .compact-dual-preview {
                grid-template-columns: 1fr;
                height: 400px;
            }
            
            .compact-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .timeline-shortcuts {
                display: none; /* åœ¨å°å±å¹•ä¸Šéšè—å¿«æ·é”®æç¤º */
            }
            
            .timeline-right-info {
                align-items: center;
            }
            
            .phase3-stats-area {
                min-width: unset;
                max-width: unset;
            }

            /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„toastæ ·å¼ */
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .toast {
                min-width: auto;
                width: 100%;
                margin-bottom: 8px;
                font-size: 0.9em;
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="top-toolbar">
            <div class="app-title" style="margin-right: 40px;">
                ğŸï¸ LapVision
                <span style="font-size: 0.8em; color: #9ca3af; margin-left: 20px;">Analysis race chrono from onboard video</span>
            </div>
            <div class="toolbar-actions">
                <div class="phase-indicator">
                    <div class="phase active" id="phase-1">åˆå§‹åŒ–</div>
                    <div class="phase" id="phase-2">è®¾ç½®å‚è€ƒå¸§</div>
                    <div class="phase" id="phase-3">æœç´¢åœˆé€Ÿ</div>
                </div>
            </div>
        </div>

        <!-- æµ®åŠ¨é€šçŸ¥å®¹å™¨ -->
        <div id="toast-container" class="toast-container"></div>

        <!-- ä¸»å†…å®¹ -->
        <div class="main-content">

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-section">
                <div class="preview-panel">
                    <div id="phase1-content">
                        <div class="preview-placeholder">
                            <div style="text-align: center;">
                                <h3>é€‰æ‹©è§†é¢‘æ–‡ä»¶å¼€å§‹</h3>
                                <p>åŠ è½½è§†é¢‘åå°†åœ¨æ­¤å¤„æ˜¾ç¤ºé¢„è§ˆ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="phase2-content" class="hidden">
                        <div class="video-preview">
                            <img id="frame-preview" src="" alt="è§†é¢‘é¢„è§ˆ" style="display: none;">
                            <div class="video-overlay" id="video-overlay">
                                <div class="playback-controls">
                                    <button class="btn-icon" id="play-pause-btn" onclick="togglePlayback()" title="æ’­æ”¾/æš‚åœ (ç©ºæ ¼)">
                                        <span id="play-icon">â–¶ï¸</span>
                                    </button>
                                </div>
                            </div>
                            <div class="video-controls">
                                <div class="video-timestamp" id="video-timestamp">00:00:00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="phase3-content" class="hidden" style="position: relative; height: 100%; width: 100%;">
                        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ - æ°´å¹³åˆ†å¸ƒ -->
                        <div class="phase3-main-layout" style="padding: 20px;">
                            <!-- å·¦ä¾§ï¼šåŒç”»é¢é¢„è§ˆ -->
                            <div class="phase3-preview-area">
                                <div class="compact-dual-preview">
                                    <!-- å‚è€ƒå¸§ -->
                                    <div class="compact-preview-half">
                                        <div class="compact-preview-header">
                                            <span class="preview-label">ğŸ å‚è€ƒå¸§</span>
                                            <span class="preview-time" id="ref-frame-timestamp">--:--:--</span>
                                        </div>
                                        <div class="compact-video-preview">
                                            <img id="ref-frame-display" src="" alt="å‚è€ƒå¸§">
                                        </div>
                                    </div>
                                    
                                    <!-- å½“å‰å¸§ -->
                                    <div class="compact-preview-half">
                                        <div class="compact-preview-header">
                                            <span class="preview-label">ğŸ¯ å½“å‰å¸§</span>
                                            <span class="preview-time" id="current-video-timestamp">00:00:00</span>
                                        </div>
                                        <div class="compact-video-preview">
                                            <img id="current-frame-display" src="" alt="å½“å‰å¸§" style="display: none;">
                                            <div class="compact-video-overlay" id="current-video-overlay">
                                                <div class="compact-playback-controls">
                                                    <button class="compact-play-btn" id="current-play-pause-btn" onclick="togglePlayback()" title="æ’­æ”¾/æš‚åœ (ç©ºæ ¼)">
                                                        <span id="current-play-icon">â–¶ï¸</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å€™é€‰å¸§åŒºåŸŸ - ç§»åˆ°é¢„è§ˆä¸‹æ–¹ -->
                                <div id="candidates-display" class="hidden">
                                    <div class="candidates-header">
                                        <h4>ğŸ” å€™é€‰ç»ˆç‚¹å¸§</h4>
                                        <span class="candidates-hint">ç‚¹å‡»é€‰æ‹©æœ€æ¥è¿‘çš„ç»ˆç‚¹</span>
                                    </div>
                                    <div class="compact-candidates-gallery" id="candidates-gallery"></div>
                                </div>
                            </div>
                            
                            <!-- å³ä¾§ï¼šç´§å‡‘ç»Ÿè®¡é¢æ¿ -->
                            <div class="phase3-stats-area">
                                <div class="compact-stats-panel" id="stats-display">
                                    <div class="compact-stats-header">
                                        <h4>ğŸ“Š åœˆé€Ÿè®°å½•</h4>
                                    </div>
                                    <div class="compact-stats-content" id="stats-container">
                                        <div class="stats-placeholder">ç­‰å¾…æœç´¢...</div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="control-panel" id="control-panel"></div>
            </div>

            <!-- æ—¶é—´è½´åŒºåŸŸ -->
            <div class="timeline-section">
                <div class="timeline-container">
                    <div class="timeline-header">
                        <div class="timeline-title">æ—¶é—´è½´</div>
                        <div class="timeline-right-info">
                            <div class="timeline-shortcuts" id="timeline-shortcuts">
                                <span class="shortcut">ç©ºæ ¼: æ’­æ”¾/æš‚åœ</span>
                                <span class="shortcut">â† â†’: é€å¸§</span>
                                <span class="shortcut">Shift+â† â†’: Â±5å¸§</span>
                            </div>
                            <div class="timeline-info" id="timeline-info">00:00:00 / 00:00:00</div>
                        </div>
                    </div>
                    <div class="timeline-track" onclick="seekToPosition(event)">
                        <div class="timeline-ruler">
                            <div class="timeline-ruler-marks"></div>
                        </div>
                        <div class="timeline-waveform"></div>
                        <div class="timeline-playhead" id="playhead" style="left: 0%;"></div>
                    </div>
                </div>




            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let appState = {
            counterId: null,
            selectedCandidate: null,
            videoInfo: null,
            sliderDebounceTimer: null,
            currentFrame: 0,
            isPlaying: false,
            playbackTimer: null,
            confirmedLaps: 0
        };

        // æ›´æ–°æ§åˆ¶é¢æ¿å†…å®¹
        function updateControlPanel(phase) {
            const panel = document.getElementById('control-panel');
            
            // æ¸…é™¤ä¹‹å‰çš„é˜¶æ®µæ ·å¼ç±»
            panel.classList.remove('phase-1-guide', 'phase-2-guide', 'phase-3-guide');
            // æ·»åŠ å½“å‰é˜¶æ®µçš„æ ·å¼ç±»
            panel.classList.add(`phase-${phase}-guide`);
            
            switch(phase) {
                case 1:
                    panel.innerHTML = `
                                <div class="guide-box">
                                    <div class="guide-icon">ğŸ</div>
                                    <div class="guide-content">
                                        <h5>Welcome to <strong>LapVision</strong> (Karting Version) </h5>
                                        <p><strong>LapVision</strong> æ˜¯ä¸€ä¸ªåŸºäºè§†è§‰çš„èµ›è½¦è®¡æ—¶å·¥å…·ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åˆ†ææ‚¨çš„èµ›é“è½¦è½½è§†é¢‘å¹¶è¾…åŠ©åˆ†ææ‚¨çš„åœˆé€Ÿä¿¡æ¯ã€‚</p>
                                        <div class="guide-steps">
                                            <div class="step">
                                                <span class="step-number">1</span>
                                                <span>åŠ è½½è¿‡ç¨‹ä¸­æœªç»å‰ªè¾‘çš„è½¦è½½è§†é¢‘</span>
                                            </div>
                                            <div class="step">
                                                <span class="step-number">2</span>
                                                <span>é€‰æ‹©ç¬¬ä¸€æ¬¡ç»è¿‡ç»ˆç‚¹/èµ·ç‚¹çº¿çš„å‚è€ƒå¸§</span>
                                            </div>
                                            <div class="step">
                                                <span class="step-number">3</span>
                                                <span>è‡ªåŠ¨åˆ†æå¹¶ç”Ÿæˆåœˆé€Ÿç»Ÿè®¡ä¿¡æ¯</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        
                        <div class="panel">
                            <div class="panel-header">
                                <h4 class="panel-title">é¡¹ç›®è®¾ç½®</h4>
                            </div>
                            <div class="panel-content">
                                <div class="form-group">
                                    <label>è§†é¢‘æ–‡ä»¶</label>
                                    <select id="video-select">
                                        <option value="">é€‰æ‹©è§†é¢‘...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>æœ€å°åœˆé€Ÿ(ç§’)</label>
                                    <input type="number" id="min-lap-time" value="18" min="1" step="0.1">
                                </div>
                                <div class="button-group">
                                    <button class="btn-primary" id="btn-init" onclick="initCounter()">
                                        åŠ è½½è§†é¢‘
                                    </button>
                                </div>
                                <div id="video-info" class="hidden" style="margin-top: 16px; padding: 12px; background: #0a0a0a; border-radius: 4px; font-size: 0.8em;">
                                    <div><strong>FPS:</strong> <span id="info-fps"></span></div>
                                    <div><strong>æ€»å¸§æ•°:</strong> <span id="info-frames"></span></div>
                                    <div><strong>æ—¶é•¿:</strong> <span id="info-duration"></span></div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 2:
                    panel.innerHTML = `
                        <div class="guide-box">
                            <div class="guide-content">
                                <h5>è®¾ç½®è®¡æ—¶èµ·ç‚¹</h5>
                                <p>è¯·å°†æ—¶é—´è½´å®šä½åˆ°æ‚¨<strong>ç¬¬ä¸€æ¬¡ç»è¿‡èµ·ç‚¹/ç»ˆç‚¹çº¿</strong>çš„ç”»é¢ä½œä¸ºå‚è€ƒå¸§ã€‚è¿™å°†ä½œä¸ºåç»­åœˆé€Ÿè®¡ç®—çš„åŸºå‡†ç‚¹ã€‚</p>
                                <div class="guide-tips">
                                    <div class="tip">ğŸ’¡ ä½¿ç”¨æ’­æ”¾æ§åˆ¶æˆ–æ‹–åŠ¨æ—¶é—´è½´å®šä½åˆ°åˆé€‚ä½ç½®</div>
                                    <div class="tip">ğŸ® æ”¯æŒé”®ç›˜å¿«æ·é”®ï¼šç©ºæ ¼æ’­æ”¾/æš‚åœï¼Œâ†â†’é€å¸§æµè§ˆ</div>
                                    <div class="tip">âš¡ Shift+â†/â†’å¯å¿«é€Ÿè·³è½¬5å¸§</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel-header">
                                <h4 class="panel-title">å¸§æ§åˆ¶</h4>
                            </div>
                            <div class="panel-content">
                                <div class="form-group">
                                    <label>å¸§å·</label>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="number" id="frame-number" value="0" min="0" style="flex: 1;">
                                        <button class="btn-secondary btn-small" onclick="jumpToFrame()">è·³è½¬</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>æ—¶é—´(ç§’)</label>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="number" id="frame-time" value="0" step="0.1" min="0" style="flex: 1;">
                                        <button class="btn-secondary btn-small" onclick="jumpToTime()">è·³è½¬</button>
                                    </div>
                                </div>
                                <div class="button-group" style="margin-top: 16px;">
                                    <button class="btn-primary" id="btn-set-ref" onclick="setReferenceFrame()">
                                        è®¾ä¸ºå‚è€ƒå¸§
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 3:
                    panel.innerHTML = `
                        <div class="guide-box">
                            <div class="guide-content">
                                <h5>å¼€å§‹åœˆé€Ÿè®¡ç®—</h5>
                                <p>ç³»ç»Ÿå°†ä½¿ç”¨AIè§†è§‰è¯†åˆ«æŠ€æœ¯ï¼Œè‡ªåŠ¨æŸ¥æ‰¾ä¸å‚è€ƒå¸§ç›¸ä¼¼çš„ç”»é¢ï¼Œç²¾ç¡®è®¡ç®—æ¯ä¸€åœˆçš„ç”¨æ—¶ã€‚</p>
                                <div class="guide-tips">
                                    <div class="tip">ğŸ¯ ç‚¹å‡»"æœç´¢ä¸‹ä¸€åœˆ"å¼€å§‹è‡ªåŠ¨åˆ†æ</div>
                                    <div class="tip">ğŸ–±ï¸ ä»å€™é€‰ç»“æœä¸­é€‰æ‹©æœ€æ¥è¿‘çš„ç»ˆç‚¹å¸§</div>
                                    <div class="tip">ğŸ® ä½¿ç”¨æ—¶é—´è½´å’Œé”®ç›˜å¿«æ·é”®è¿›è¡Œç²¾ç¡®è°ƒæ•´</div>
                                    <div class="tip">âœ… ç¡®è®¤åç»§ç»­æœç´¢æ›´å¤šåœˆé€Ÿ</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel-header">
                                <h4 class="panel-title">åœˆé€Ÿæœç´¢</h4>
                            </div>
                            <div class="panel-content">
                                <div class="button-group">
                                    <button class="btn-primary" id="btn-search" onclick="searchLap()">
                                        ğŸ” å¼€å§‹åˆ†æ
                                    </button>
                                </div>
                                <div class="button-group" style="margin-top: 12px;">
                                    <button class="btn-secondary" id="btn-save" onclick="saveResults()">
                                        ğŸ’¾ ä¿å­˜ç»“æœ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            // é‡æ–°åŠ è½½è§†é¢‘åˆ—è¡¨ï¼ˆå¦‚æœåœ¨é˜¶æ®µ1ï¼‰
            if (phase === 1) {
                // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ç¡®ä¿DOMå…ƒç´ å·²åˆ›å»º
                setTimeout(() => {
                    loadVideos();
                }, 50);
            }
        }

        // æ›´æ–°æ—¶é—´è½´ä½ç½®
        function updateTimelinePosition() {
            if (!appState.videoInfo) return;
            
            const percentage = (appState.currentFrame / appState.videoInfo.total_frames) * 100;
            const playhead = document.getElementById('playhead');
            if (playhead) {
                playhead.style.left = percentage + '%';
            }
            
            const currentTime = appState.currentFrame / appState.videoInfo.fps;
            const totalTime = appState.videoInfo.duration;
            const timeInfo = document.getElementById('timeline-info');
            if (timeInfo) {
                timeInfo.textContent = formatTime(currentTime) + ' / ' + formatTime(totalTime);
            }
        }

        // ç‚¹å‡»æ—¶é—´è½´è·³è½¬
        function seekToPosition(event) {
            if (!appState.videoInfo) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = x / rect.width;
            const targetFrame = Math.floor(percentage * appState.videoInfo.total_frames);
            
            getFrame(targetFrame);
        }

        // æ’­æ”¾æ§åˆ¶åŠŸèƒ½
        function togglePlayback() {
            if (!appState.videoInfo || !appState.counterId) return;
            
            if (appState.isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (appState.isPlaying) return;
            
            appState.isPlaying = true;
            updatePlaybackButton();
            
            // ä»¥è§†é¢‘çš„å®é™…FPSæ’­æ”¾ï¼ˆé™åˆ¶æœ€é«˜30fpsä»¥ä¿è¯æµç•…æ€§ï¼‰
            const playbackFPS = Math.min(appState.videoInfo.fps, 30);
            const frameInterval = 1000 / playbackFPS;
            
            appState.playbackTimer = setInterval(() => {
                if (appState.currentFrame >= appState.videoInfo.total_frames - 1) {
                    pausePlayback(); // æ’­æ”¾åˆ°ç»“å°¾è‡ªåŠ¨æš‚åœ
                    return;
                }
                
                const nextFrame = appState.currentFrame + 1;
                getFrame(nextFrame);
            }, frameInterval);
        }

        function pausePlayback() {
            if (!appState.isPlaying) return;
            
            appState.isPlaying = false;
            updatePlaybackButton();
            
            if (appState.playbackTimer) {
                clearInterval(appState.playbackTimer);
                appState.playbackTimer = null;
            }
        }

        function updatePlaybackButton() {
            // æ›´æ–°é˜¶æ®µ2çš„æ’­æ”¾æŒ‰é’®å›¾æ ‡
            const playIcon = document.getElementById('play-icon');
            if (playIcon) {
                playIcon.textContent = appState.isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
            }
            
            // æ›´æ–°é˜¶æ®µ3å³ä¾§é¢„è§ˆçš„æ’­æ”¾æŒ‰é’®å›¾æ ‡
            const currentPlayIcon = document.getElementById('current-play-icon');
            if (currentPlayIcon) {
                currentPlayIcon.textContent = appState.isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
            }
            
            // æ›´æ–°æŒ‰é’®æ ‡é¢˜
            const playButton = document.getElementById('play-pause-btn');
            if (playButton) {
                playButton.title = appState.isPlaying ? 'æš‚åœ (ç©ºæ ¼)' : 'æ’­æ”¾ (ç©ºæ ¼)';
            }
            
            const currentPlayButton = document.getElementById('current-play-pause-btn');
            if (currentPlayButton) {
                currentPlayButton.title = appState.isPlaying ? 'æš‚åœ (ç©ºæ ¼)' : 'æ’­æ”¾ (ç©ºæ ¼)';
            }
            
            // åœ¨æ—¶é—´è½´åŒºåŸŸæ˜¾ç¤ºæ’­æ”¾çŠ¶æ€
            const timelineTitle = document.querySelector('.timeline-title');
            if (timelineTitle) {
                timelineTitle.textContent = appState.isPlaying ? 'VIDEO TIMELINE (æ’­æ”¾ä¸­)' : 'VIDEO TIMELINE';
            }
        }

        // å¸§å¯¼èˆªåŠŸèƒ½
        function goToNextFrame(step = 1) {
            if (!appState.videoInfo) return;
            
            const targetFrame = Math.min(
                appState.currentFrame + step, 
                appState.videoInfo.total_frames - 1
            );
            
            if (targetFrame !== appState.currentFrame) {
                getFrame(targetFrame);
            }
        }

        function goToPreviousFrame(step = 1) {
            if (!appState.videoInfo) return;
            
            const targetFrame = Math.max(appState.currentFrame - step, 0);
            
            if (targetFrame !== appState.currentFrame) {
                getFrame(targetFrame);
            }
        }

        // ============ åˆå§‹åŒ– ============

        async function loadVideos() {
            try {
                const response = await fetch('/api/videos');
                const result = await response.json();
                
                const select = document.getElementById('video-select');
                if (!select) {
                    console.warn('Video select element not found');
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                select.innerHTML = '<option value="">é€‰æ‹©è§†é¢‘...</option>';
                
                result.data.videos.forEach(video => {
                    const option = document.createElement('option');
                    option.value = video.path;
                    option.textContent = video.name;
                    select.appendChild(option);
                });
            } catch (error) {
                showMessage(`åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥: ${error}`, 'error');
            }
        }

        async function initCounter() {
            try {
                const videoSelect = document.getElementById('video-select');
                const minLapTimeInput = document.getElementById('min-lap-time');
                
                if (!videoSelect || !minLapTimeInput) {
                    showMessage('ç•Œé¢æœªæ­£ç¡®åˆå§‹åŒ–', 'error');
                    return;
                }
                
                const videoPath = videoSelect.value;
                const minLapTime = parseFloat(minLapTimeInput.value);

                if (!videoPath) {
                    showMessage('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                    return;
                }

                setButtonLoading('btn-init', true);

                const response = await fetch('/api/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_path: videoPath, min_lap_time: minLapTime })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    appState.counterId = result.data.counter_id;
                    appState.videoInfo = result.data.video_info;

                    // æ›´æ–°è§†é¢‘ä¿¡æ¯æ˜¾ç¤º
                    setTimeout(() => {
                        const fpsElem = document.getElementById('info-fps');
                        const framesElem = document.getElementById('info-frames');
                        const durationElem = document.getElementById('info-duration');
                        const videoInfoElem = document.getElementById('video-info');
                        
                        if (fpsElem) fpsElem.textContent = result.data.video_info.fps.toFixed(2);
                        if (framesElem) framesElem.textContent = result.data.video_info.total_frames;
                        if (durationElem) durationElem.textContent = result.data.video_info.formatted_duration;
                        if (videoInfoElem) videoInfoElem.classList.remove('hidden');
                    }, 100);

                    // è¿›å…¥é˜¶æ®µ2
                    transitionToPhase(2);
                    await loadFirstFrame();

                    showMessage('è§†é¢‘åŠ è½½æˆåŠŸï¼', 'success');
                } else {
                    showMessage(`åˆå§‹åŒ–å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`é”™è¯¯: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-init', false);
            }
        }

        // ============ å¸§ç®¡ç† ============

        async function loadFirstFrame() {
            await getFrame(0);
        }

        async function getFrame(frameIdx) {
            try {
                const response = await fetch(`/api/frame/${appState.counterId}/${frameIdx}`);
                const result = await response.json();

                if (result.status === 'success') {
                    // æ›´æ–°é˜¶æ®µ2çš„é¢„è§ˆå›¾åƒ
                    const img = document.getElementById('frame-preview');
                    if (img) {
                        img.src = `data:image/png;base64,${result.data.image_base64}`;
                        img.style.display = 'block';
                    }

                    // æ›´æ–°é˜¶æ®µ3çš„å³ä¾§å½“å‰å¸§æ˜¾ç¤º
                    const currentImg = document.getElementById('current-frame-display');
                    if (currentImg) {
                        currentImg.src = `data:image/png;base64,${result.data.image_base64}`;
                        currentImg.style.display = 'block';
                    }

                    // æ›´æ–°å½“å‰å¸§çŠ¶æ€
                    appState.currentFrame = frameIdx;
                    
                    // æ›´æ–°æ§åˆ¶è¾“å…¥æ¡†
                    const frameNumberInput = document.getElementById('frame-number');
                    const frameTimeInput = document.getElementById('frame-time');
                    const timestampDisplay = document.getElementById('video-timestamp');
                    const currentTimestampDisplay = document.getElementById('current-video-timestamp');
                    
                    if (frameNumberInput && !appState.isPlaying) frameNumberInput.value = frameIdx;
                    if (frameTimeInput && !appState.isPlaying) frameTimeInput.value = result.data.time_sec.toFixed(2);
                    if (timestampDisplay) timestampDisplay.textContent = result.data.formatted_time;
                    if (currentTimestampDisplay) currentTimestampDisplay.textContent = result.data.formatted_time;
                    
                    // æ›´æ–°æ—¶é—´è½´
                    updateTimelinePosition();
                }
            } catch (error) {
                showMessage(`åŠ è½½å¸§å¤±è´¥: ${error}`, 'error');
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæš‚åœæ’­æ”¾
                if (appState.isPlaying) {
                    pausePlayback();
                }
            }
        }



        // æ·»åŠ æ ¼å¼åŒ–æ—¶é—´çš„è¾…åŠ©å‡½æ•°
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const millis = Math.floor((seconds - Math.floor(seconds)) * 1000);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${millis.toString().padStart(3, '0')}`;
        }

        function jumpToFrame() {
            const frameNumberInput = document.getElementById('frame-number');
            if (!frameNumberInput || !appState.videoInfo) {
                showMessage('ç³»ç»Ÿæœªå°±ç»ª', 'error');
                return;
            }
            
            const frameIdx = parseInt(frameNumberInput.value);
            if (frameIdx < 0 || frameIdx >= appState.videoInfo.total_frames) {
                showMessage('å¸§å·æ— æ•ˆ', 'error');
                return;
            }
            getFrame(frameIdx);
        }

        function jumpToTime() {
            const frameTimeInput = document.getElementById('frame-time');
            if (!frameTimeInput || !appState.videoInfo) {
                showMessage('ç³»ç»Ÿæœªå°±ç»ª', 'error');
                return;
            }
            
            const timeSec = parseFloat(frameTimeInput.value);
            const frameIdx = Math.floor(timeSec * appState.videoInfo.fps);
            getFrame(frameIdx);
        }

        // ============ å‚è€ƒå¸§ ============

        async function setReferenceFrame() {
            // æš‚åœæ’­æ”¾
            if (appState.isPlaying) {
                pausePlayback();
            }
            try {
                const frameNumberInput = document.getElementById('frame-number');
                if (!frameNumberInput || !appState.videoInfo) {
                    showMessage('ç³»ç»Ÿæœªå°±ç»ª', 'error');
                    return;
                }
                
                const frameIdx = parseInt(frameNumberInput.value);
                setButtonLoading('btn-set-ref', true);

                const response = await fetch(`/api/set-ref-frame/${appState.counterId}/${frameIdx}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    const img = document.getElementById('ref-frame-display');
                    if (img) {
                        img.src = `data:image/png;base64,${result.data.image_base64}`;
                    }

                    // æ›´æ–°å‚è€ƒå¸§æ—¶é—´æˆ³æ˜¾ç¤º
                    const refTimestamp = document.getElementById('ref-frame-timestamp');
                    if (refTimestamp && result.data.formatted_time) {
                        refTimestamp.textContent = `å‚è€ƒå¸§ - ${result.data.formatted_time}`;
                    }

                    showMessage('å‚è€ƒå¸§è®¾ç½®æˆåŠŸï¼', 'success');
                    transitionToPhase(3);
                    
                    // å»¶è¿Ÿæ›´æ–°æŒ‡å—æç¤ºï¼Œç¡®ä¿é¢æ¿å·²åˆ‡æ¢
                    setTimeout(() => {
                        updateDynamicGuide('å‚è€ƒå¸§å·²è®¾ç½®', 'ç°åœ¨å¯ä»¥å¼€å§‹æœç´¢å¡ä¸è½¦çš„ä¸‹ä¸€åœˆã€‚ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«ç›¸ä¼¼çš„å†²çº¿ç”»é¢ã€‚');
                    }, 300);
                } else {
                    showMessage(`è®¾ç½®å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`é”™è¯¯: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-set-ref', false);
            }
        }

        // ============ æœç´¢ ============

        async function searchLap() {
            try {
                setButtonLoading('btn-search', true);

                const response = await fetch(`/api/search-lap/${appState.counterId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ search_range: 10 })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    displayCandidates(result.data.candidates);
                    showMessage('æœç´¢å®Œæˆï¼è¯·ç‚¹å‡»æœ€æ¥è¿‘çš„å€™é€‰å¸§', 'success');
                } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è§†é¢‘ç»“æŸçš„é”™è¯¯
                    if (result.message && (result.message.includes('è§†é¢‘æœ«å°¾') || result.message.includes('è§†é¢‘å·²ç»“æŸ') || result.message.includes('å‰©ä½™æ—¶é•¿ä¸è¶³'))) {
                        showMessage('ğŸ è§†é¢‘åˆ†æå®Œæˆï¼å·²åˆ°è¾¾è§†é¢‘æœ«å°¾ï¼Œæ— æ³•ç»§ç»­æœç´¢æ›´å¤šåœˆé€Ÿã€‚', 'info');
                        updateDynamicGuide('åˆ†æå®Œæˆ', 'è§†é¢‘å·²åˆ†æå®Œæ¯•ã€‚æ‚¨å¯ä»¥ä¿å­˜å½“å‰ç»“æœæˆ–é‡æ–°å¼€å§‹åˆ†æã€‚');
                    } else {
                        showMessage(`æœç´¢å¤±è´¥: ${result.message}`, 'error');
                    }
                }
            } catch (error) {
                showMessage(`é”™è¯¯: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-search', false);
            }
        }

        function displayCandidates(candidates) {
            const gallery = document.getElementById('candidates-gallery');
            const candidatesDisplay = document.getElementById('candidates-display');
            
            // æ˜¾ç¤ºå€™é€‰å¸§åŒºåŸŸ
            if (candidatesDisplay) {
                candidatesDisplay.classList.remove('hidden');
            }
            
            gallery.innerHTML = '';

            candidates.forEach((candidate, idx) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.onclick = () => selectCandidate(candidate, item);
                
                item.innerHTML = `
                    <img src="data:image/png;base64,${candidate.image_base64}" alt="å€™é€‰å¸§">
                    <div class="label">
                        <div>${candidate.formatted_time}</div>
                        <div>ç›¸ä¼¼åº¦: ${(candidate.similarity * 100).toFixed(1)}%</div>
                    </div>
                `;
                
                gallery.appendChild(item);
            });
            
            // æ›´æ–°æŒ‡å—æç¤º - æ ¹æ®æ˜¯å¦æœ‰å·²ç¡®è®¤åœˆé€Ÿåˆ¤æ–­æç¤ºå†…å®¹
            const isFirstLap = !appState.confirmedLaps || appState.confirmedLaps === 0;
            
            if (isFirstLap) {
                updateDynamicGuide('å€™é€‰å¸§å·²ç”Ÿæˆ', 'è¯·ç‚¹å‡»æœ€æ¥è¿‘ç¬¬ä¸€æ¬¡å†²çº¿ä½ç½®çš„å€™é€‰å¸§ï¼Œé¢„è§ˆå°†è‡ªåŠ¨è·³è½¬åˆ°è¯¥ä½ç½®ã€‚');
            } else {
                const nextLapNumber = appState.confirmedLaps + 1;
                updateDynamicGuide(`ç¬¬${nextLapNumber}åœˆå€™é€‰å¸§å·²ç”Ÿæˆ`, 'è¯·ç‚¹å‡»æœ€æ¥è¿‘ä¸‹ä¸€æ¬¡å†²çº¿ä½ç½®çš„å€™é€‰å¸§ï¼Œé¢„è§ˆå°†è‡ªåŠ¨è·³è½¬åˆ°è¯¥ä½ç½®ã€‚');
            }
        }

        function selectCandidate(candidate, element) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.gallery-item').forEach(item => item.classList.remove('selected'));
            
            // æ ‡è®°å½“å‰é€‰æ‹©
            element.classList.add('selected');
            appState.selectedCandidate = candidate;

            // ç›´æ¥è·³è½¬åˆ°å€™é€‰å¸§
            getFrame(candidate.frame_idx);
            
            // æ›´æ–°æ§åˆ¶é¢æ¿ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            updateControlPanelForConfirm();
            
            // æ›´æ–°æŒ‡å—æç¤º
            updateDynamicGuide('å·²é€‰æ‹©å€™é€‰å¸§', `å·²è·³è½¬è‡³ç¬¬${candidate.frame_idx}å¸§ï¼ˆ${candidate.formatted_time}ï¼‰ã€‚è¯·ä½¿ç”¨æ—¶é—´è½´ã€é”®ç›˜å¿«æ·é”®æˆ–å¸§æ§åˆ¶è¿›è¡Œç²¾ç¡®è°ƒæ•´ï¼Œç„¶åç¡®è®¤ä¸ºæœ¬åœˆç»ˆç‚¹ã€‚`);
        }



        // ============ ç¡®è®¤ ============

        async function confirmCurrentFrame() {
            try {
                // ä½¿ç”¨å½“å‰é¢„è§ˆä¸­çš„å¸§ä½œä¸ºç¡®è®¤å¸§
                const frameIdx = appState.currentFrame;
                
                setButtonLoading('btn-confirm-lap', true);

                const response = await fetch(`/api/confirm-lap/${appState.counterId}/${frameIdx}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    updateStatistics(result.data.statistics);
                    showMessage(`åœˆé€Ÿå·²ç¡®è®¤: ${result.data.formatted_lap_time}`, 'success');
                    
                    // æ›´æ–°å·²ç¡®è®¤åœˆæ•°
                    appState.confirmedLaps = result.data.statistics.total_laps;
                    
                    // é‡ç½®æœç´¢çŠ¶æ€
                    document.getElementById('candidates-gallery').innerHTML = '';
                    const candidatesDisplay = document.getElementById('candidates-display');
                    if (candidatesDisplay) {
                        candidatesDisplay.classList.add('hidden');
                    }
                    appState.selectedCandidate = null;
                    
                    // è¿”å›åˆ°æœç´¢æ¨¡å¼
                    updateControlPanel(3);
                    
                    // æ›´æ–°æŒ‡å—æç¤ºå¹¶è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€åœˆæœç´¢
                    const lapNumber = result.data.statistics.total_laps;
                    updateDynamicGuide('è‡ªåŠ¨æœç´¢ä¸­...', `ç¬¬${lapNumber}åœˆå·²ç¡®è®¤ï¼ˆ${result.data.formatted_lap_time}ï¼‰ã€‚æ­£åœ¨è‡ªåŠ¨æœç´¢ç¬¬${lapNumber + 1}åœˆ...`);
                    
                    // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°ç¡®è®¤æ¶ˆæ¯ï¼Œç„¶åè‡ªåŠ¨æœç´¢ä¸‹ä¸€åœˆ
                    setTimeout(async () => {
                        try {
                            // å°è¯•æœç´¢ä¸‹ä¸€åœˆ
                            const searchResponse = await fetch(`/api/search-lap/${appState.counterId}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ search_range: 10 })
                            });
                            
                            const searchResult = await searchResponse.json();
                            
                            if (searchResult.status === 'success') {
                                displayCandidates(searchResult.data.candidates);
                                updateDynamicGuide('å€™é€‰å¸§å·²ç”Ÿæˆ', `ç¬¬${lapNumber + 1}åœˆå€™é€‰å¸§å·²ç”Ÿæˆï¼Œè¯·é€‰æ‹©æœ€æ¥è¿‘çš„ç»ˆç‚¹å¸§ã€‚`);
                            } else {
                                // æ£€æŸ¥æ˜¯å¦æ˜¯è§†é¢‘ç»“æŸ
                                if (searchResult.message && (searchResult.message.includes('è§†é¢‘æœ«å°¾') || searchResult.message.includes('è§†é¢‘å·²ç»“æŸ') || searchResult.message.includes('å‰©ä½™æ—¶é•¿ä¸è¶³'))) {
                                    updateDynamicGuide('ğŸ åˆ†æå®Œæˆ', `è§†é¢‘åˆ†æå®Œæ¯•ï¼å…±å®Œæˆ${lapNumber}åœˆåˆ†æã€‚å¯ä»¥ä¿å­˜ç»“æœæˆ–é‡æ–°å¼€å§‹åˆ†æã€‚`);
                                    showMessage('ğŸ è§†é¢‘åˆ†æå®Œæˆï¼', 'info');
                                } else {
                                    updateDynamicGuide('æœç´¢å®Œæˆ', `å·²å®Œæˆ${lapNumber}åœˆåˆ†æã€‚å¯ä»¥æ‰‹åŠ¨æœç´¢æ›´å¤šåœˆé€Ÿæˆ–ä¿å­˜å½“å‰ç»“æœã€‚`);
                                }
                            }
                        } catch (error) {
                            updateDynamicGuide('æœç´¢å®Œæˆ', `å·²å®Œæˆ${lapNumber}åœˆåˆ†æã€‚å¯ä»¥æ‰‹åŠ¨æœç´¢æ›´å¤šåœˆé€Ÿæˆ–ä¿å­˜å½“å‰ç»“æœã€‚`);
                        }
                    }, 1000);
                } else {
                    showMessage(`ç¡®è®¤å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`é”™è¯¯: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-confirm-lap', false);
            }
        }

        function cancelSelection() {
            // æ¸…é™¤é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.gallery-item').forEach(item => item.classList.remove('selected'));
            appState.selectedCandidate = null;
            
            // éšè—å€™é€‰å¸§æ˜¾ç¤º
            const candidatesDisplay = document.getElementById('candidates-display');
            if (candidatesDisplay) {
                candidatesDisplay.classList.add('hidden');
            }
            
            // è¿”å›åˆ°æœç´¢æ¨¡å¼
            updateControlPanel(3);
            
            // æ›´æ–°æŒ‡å—æç¤º
            updateDynamicGuide('å·²å–æ¶ˆé€‰æ‹©', 'è¯·é‡æ–°æœç´¢åœˆé€Ÿæˆ–ä»å€™é€‰å¸§ä¸­é€‰æ‹©åˆé€‚çš„ç»ˆç‚¹å¸§ã€‚');
        }



        function updateStatistics(stats) {
            const container = document.getElementById('stats-container');
            
            if (stats.total_laps === 0) {
                container.innerHTML = '<div class="stats-placeholder">æš‚æ— æ•°æ®</div>';
                return;
            }

            let html = `
                <div class="compact-stats-grid">
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">æ€»åœˆæ•°</div>
                        <div class="compact-stat-value">${stats.total_laps}</div>
                    </div>
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">æœ€å¿«åœˆ</div>
                        <div class="compact-stat-value">${stats.best_lap}</div>
                    </div>
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">æœ€æ…¢åœˆ</div>
                        <div class="compact-stat-value">${stats.worst_lap}</div>
                    </div>
                    <div class="compact-stat-box">
                        <div class="compact-stat-label">å¹³å‡åœˆ</div>
                        <div class="compact-stat-value">${stats.average_lap}</div>
                    </div>
                </div>
                <div class="compact-laps-list">
            `;

            stats.laps.forEach(lap => {
                const isLatest = lap.lap_number === stats.total_laps;
                html += `
                    <div class="compact-lap-item ${isLatest ? 'latest-lap' : ''}">
                        <span>ç¬¬ ${lap.lap_number} åœˆ</span>
                        <span style="color: ${isLatest ? '#10b981' : '#3b82f6'}; font-weight: 600;">${lap.formatted_time}</span>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ============ ä¿å­˜ ============

        async function saveResults() {
            try {
                setButtonLoading('btn-save', true);

                const response = await fetch(`/api/save-results/${appState.counterId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showMessage('âœ… ç»“æœå·²ä¿å­˜ï¼', 'success');
                } else {
                    showMessage(`ä¿å­˜å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`é”™è¯¯: ${error}`, 'error');
            } finally {
                setButtonLoading('btn-save', false);
            }
        }

        // ============ å·¥å…·å‡½æ•° ============

        // åŠ¨æ€æ›´æ–°æŒ‡å—æç¤º
        function updateDynamicGuide(title, message) {
            const guideContent = document.querySelector('.guide-content');
            if (!guideContent) return;
            
            const h5 = guideContent.querySelector('h5');
            const p = guideContent.querySelector('p');
            
            if (h5 && p) {
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                guideContent.style.opacity = '0.5';
                guideContent.style.transform = 'scale(0.98)';
                
                setTimeout(() => {
                    h5.textContent = title;
                    p.textContent = message;
                    guideContent.style.opacity = '1';
                    guideContent.style.transform = 'scale(1)';
                    guideContent.style.transition = 'all 0.3s ease';
                }, 150);
            }
        }

        // æ›´æ–°æ§åˆ¶é¢æ¿ä»¥æ˜¾ç¤ºç¡®è®¤é€‰é¡¹
        function updateControlPanelForConfirm() {
            const panel = document.getElementById('control-panel');
            
            // ä¿æŒå½“å‰é˜¶æ®µæ ·å¼
            const currentPhase = panel.classList.contains('phase-1-guide') ? 1 : 
                               panel.classList.contains('phase-2-guide') ? 2 : 3;
            
            panel.innerHTML = `
                <div class="panel">
                    <div class="panel-header">
                        <h4 class="panel-title">ğŸ¯ ç¡®è®¤ç»ˆç‚¹å¸§</h4>
                    </div>
                    <div class="panel-content">
                        <div class="guide-box">
                            <div class="guide-content">
                                <h5>å·²é€‰æ‹©å€™é€‰å¸§</h5>
                                <p>å½“å‰é¢„è§ˆå·²è·³è½¬è‡³å€™é€‰å¸§ä½ç½®ã€‚è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡Œç²¾ç¡®è°ƒæ•´ï¼Œç„¶åç¡®è®¤ä¸ºæœ¬åœˆç»ˆç‚¹ã€‚</p>
                                <div class="guide-tips">
                                    <div class="tip">ğŸ® é”®ç›˜æ§åˆ¶ï¼šâ†â†’é€å¸§ï¼ŒShift+â†â†’è·³5å¸§</div>
                                    <div class="tip">ğŸ–±ï¸ ç‚¹å‡»æ—¶é—´è½´å¿«é€Ÿè·³è½¬</div>
                                    <div class="tip">ğŸ“ ä½¿ç”¨å¸§å·/æ—¶é—´è¾“å…¥æ¡†ç²¾ç¡®å®šä½</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <h4 class="panel-title">å¸§æ§åˆ¶</h4>
                    </div>
                    <div class="panel-content">
                        <div class="form-group">
                            <label>å¸§å·</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="frame-number" value="${appState.currentFrame}" min="0" style="flex: 1;">
                                <button class="btn-secondary btn-small" onclick="jumpToFrame()">è·³è½¬</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>æ—¶é—´(ç§’)</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="frame-time" value="${(appState.currentFrame / appState.videoInfo.fps).toFixed(2)}" step="0.1" min="0" style="flex: 1;">
                                <button class="btn-secondary btn-small" onclick="jumpToTime()">è·³è½¬</button>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 16px;">
                            <button class="btn-primary" id="btn-confirm-lap" onclick="confirmCurrentFrame()">
                                âœ… ç¡®è®¤ä¸ºæœ¬åœˆç»ˆç‚¹
                            </button>
                        </div>
                        <div class="button-group" style="margin-top: 8px;">
                            <button class="btn-secondary btn-small" onclick="cancelSelection()">
                                â†©ï¸ é‡æ–°é€‰æ‹©
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function transitionToPhase(phase) {
            // æš‚åœæ’­æ”¾ï¼ˆå¦‚æœæ­£åœ¨æ’­æ”¾ï¼‰
            if (appState.isPlaying) {
                pausePlayback();
            }
            
            // æ›´æ–°é˜¶æ®µæŒ‡ç¤º
            for (let i = 1; i <= 3; i++) {
                const phaseDiv = document.getElementById(`phase-${i}`);
                phaseDiv.classList.remove('active', 'completed');
                if (i < phase) {
                    phaseDiv.classList.add('completed');
                } else if (i === phase) {
                    phaseDiv.classList.add('active');
                }
            }

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.getElementById('phase1-content').classList.toggle('hidden', phase !== 1);
            document.getElementById('phase2-content').classList.toggle('hidden', phase !== 2);
            document.getElementById('phase3-content').classList.toggle('hidden', phase !== 3);
            
            // æ›´æ–°æ§åˆ¶é¢æ¿
            updateControlPanel(phase);
            
            // æ˜¾ç¤º/éšè—ç›¸å…³åŒºåŸŸ - å€™é€‰å¸§ç°åœ¨åœ¨phase3-contentå†…éƒ¨ç®¡ç†
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡
            let icon = '';
            switch(type) {
                case 'success':
                    icon = 'âœ…';
                    break;
                case 'error':
                    icon = 'âŒ';
                    break;
                case 'info':
                default:
                    icon = 'â„¹ï¸';
                    break;
            }
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                ${message}
                <button class="toast-close" onclick="closeToast(this)">&times;</button>
            `;
            
            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(toast);
            
            // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // è‡ªåŠ¨å…³é—­ï¼ˆé”™è¯¯æ¶ˆæ¯æŒç»­æ›´é•¿æ—¶é—´ï¼‰
            const duration = type === 'error' ? 8000 : 4000;
            setTimeout(() => {
                closeToast(toast.querySelector('.toast-close'));
            }, duration);
        }

        function closeToast(closeBtn) {
            const toast = closeBtn.parentElement;
            toast.classList.remove('show');
            toast.style.animation = 'slideOutToast 0.3s ease forwards';
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        function setButtonLoading(buttonId, loading) {
            const btn = document.getElementById(buttonId);
            if (!btn) {
                console.warn(`Button with id "${buttonId}" not found`);
                return;
            }
            
            btn.disabled = loading;
            
            if (loading) {
                // ä¿å­˜åŸå§‹æ–‡æœ¬
                if (!btn.dataset.originalText) {
                    btn.dataset.originalText = btn.innerHTML;
                }
                btn.innerHTML = '<span class="loading"></span> åŠ è½½ä¸­...';
            } else {
                // æ¢å¤åŸå§‹æ–‡æœ¬
                if (btn.dataset.originalText) {
                    btn.innerHTML = btn.dataset.originalText;
                }
            }
        }

        // ============ é”®ç›˜æ§åˆ¶ ============

        function setupKeyboardControls() {
            document.addEventListener('keydown', (event) => {
                // å¦‚æœç”¨æˆ·æ­£åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ï¼Œä¸å¤„ç†å¿«æ·é”®
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                // é˜»æ­¢é»˜è®¤è¡Œä¸º
                const handled = handleKeyboardShortcut(event);
                if (handled) {
                    event.preventDefault();
                }
            });
        }

        function handleKeyboardShortcut(event) {
            const { code, shiftKey, ctrlKey, altKey } = event;
            
            // åªåœ¨æœ‰è§†é¢‘åŠ è½½æ—¶å¤„ç†å¿«æ·é”®
            if (!appState.videoInfo || !appState.counterId) {
                return false;
            }
            
            switch (code) {
                case 'Space':
                    // ç©ºæ ¼é”®ï¼šæ’­æ”¾/æš‚åœ
                    togglePlayback();
                    return true;
                    
                case 'ArrowLeft':
                    // å·¦ç®­å¤´ï¼šä¸Šä¸€å¸§ (Shift+å·¦ç®­å¤´ï¼šå‘å‰è·³5å¸§)
                    if (shiftKey) {
                        goToPreviousFrame(5);
                    } else {
                        goToPreviousFrame(1);
                    }
                    return true;
                    
                case 'ArrowRight':
                    // å³ç®­å¤´ï¼šä¸‹ä¸€å¸§ (Shift+å³ç®­å¤´ï¼šå‘åè·³5å¸§)
                    if (shiftKey) {
                        goToNextFrame(5);
                    } else {
                        goToNextFrame(1);
                    }
                    return true;
                    
                case 'Home':
                    // Homeé”®ï¼šè·³è½¬åˆ°å¼€å§‹
                    getFrame(0);
                    return true;
                    
                case 'End':
                    // Endé”®ï¼šè·³è½¬åˆ°ç»“æŸ
                    getFrame(appState.videoInfo.total_frames - 1);
                    return true;
                    
                case 'KeyJ':
                    // Jé”®ï¼šå‘å‰è·³10å¸§
                    goToPreviousFrame(10);
                    return true;
                    
                case 'KeyL':
                    // Lé”®ï¼šå‘åè·³10å¸§  
                    goToNextFrame(10);
                    return true;
                    
                case 'KeyK':
                    // Ké”®ï¼šæ’­æ”¾/æš‚åœ (å¤‡ç”¨)
                    togglePlayback();
                    return true;
                    
                default:
                    return false;
            }
        }

        // ============ åˆå§‹åŒ–åº”ç”¨ ============

        window.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–ä¸ºé˜¶æ®µ1
            transitionToPhase(1);
            
            // è®¾ç½®é”®ç›˜æ§åˆ¶
            setupKeyboardControls();
        });
    </script>
</body>
</html>
